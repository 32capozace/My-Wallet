var SharedCoin=new function(){var d=this;var g=0.5;var n=1;var c=120000;var h=3;var p=0;var l=120000;var q={};var j=3;var k=MyWallet.getSharedcoinEndpoint()+"?version="+j;var f={};var b="sharedcoin-seed-v2:";var a="sharedcoin-seed:";function m(t){var s=0,r;for(r in t){s++}return s}function o(u){var r=u.split("\n");var t="";for(var s in r){t+="     "+r[s]+"\n"}return t}(function(r){r.retryAjax=function(t){var s;t.tryCount=(!t.tryCount)?0:t.tryCount;t.retryLimit=(!t.retryLimit)?2:t.retryLimit;t.suppressErrors=true;if(t.error){s=t.error;delete t.error}else{s=function(){}}t.complete=function(u,v){if(r.inArray(v,["timeout","abort","error"])>-1){this.tryCount++;if(this.tryCount<=this.retryLimit){if(this.tryCount===this.retryLimit){this.error=s;delete this.suppressErrors}(function(w){setTimeout(function(){r.ajax(w)},5000)})(this);return true}return true}};r.ajax(t)}}(jQuery));Bitcoin.Transaction.deserialize=function(A){function s(J){var H,I;H=J.splice(0,1)[0];if(H<253){I=[H]}else{if(H==253){I=J.splice(0,2)}else{if(H==254){I=J.splice(0,4)}else{I=J.splice(0,8)}}}return BigInteger.fromByteArrayUnsigned(I)}function D(H){return new BigInteger(H.splice(0,4).reverse()).intValue()}var C=new Bitcoin.Transaction();C.version=D(A);var w=s(A).intValue();for(var B=0;B<w;B++){var x=A.splice(0,32);var u=Crypto.util.bytesToBase64(x);var r=D(A);var z=s(A).intValue();var E=new Bitcoin.Script(A.splice(0,z));var v=D(A);var F=new Bitcoin.TransactionIn({outpoint:{hash:u,index:r},script:E,sequence:v});C.ins.push(F)}var G=s(A).intValue();for(var B=0;B<G;B++){var t=A.splice(0,8);var z=s(A).intValue();var E=new Bitcoin.Script(A.splice(0,z));var y=new Bitcoin.TransactionOut({script:E,value:t});C.outs.push(y)}C.lock_time=D(A);return C};function i(v,y){var w=[];var r=Math.round(v*1/y);var x=Math.round(0.5*r);var t=0;for(var s=0;s<y;s++){var u=Math.floor((Math.random()*r)+x);if(t+u>v||s==y-1){u=v-t}t+=u;w[s]=u;if(t==v){break}}return w}var e={show:function(){var r=this;r.modal=$("#sharedcoin-modal");r.modal.modal({keyboard:false,backdrop:"static",show:true});r.modal.find(".btn.btn-secondary").unbind().click(function(){r.hide()})},setAddressAndAmount:function(r,s){if(this.modal){this.modal.find(".total_value").text(formatBTC(s));this.modal.find(".address").text(r)}},hide:function(){if(this.modal){this.modal.modal("hide")}},disableCancel:function(){if(this.modal){this.modal.find(".alert-warning").show();this.modal.find(".alert-error").hide();this.modal.find(".btn.btn-secondary").prop("disabled",true)}},enableCancel:function(){if(this.modal){this.modal.find(".alert-error").show();this.modal.find(".alert-warning").hide();this.modal.find(".btn.btn-secondary").prop("disabled",false)}}};this.newProposal=function(){return{_pollForCompleted:function(t,s){var r=this;console.log("Offer._pollForCompleted()");MyWallet.setLoadingText("Waiting For Other Participants To Sign");$.retryAjax({dataType:"json",type:"POST",url:k,timeout:c,retryLimit:4,data:{method:"poll_for_proposal_completed",format:"json",proposal_id:r.proposal_id},success:function(u){t(u)},error:function(u){s(u.responseText)}})},pollForCompleted:function(u,s){var r=this;var t=function(v){if(v.status=="waiting"){r._pollForCompleted(t,s)}else{if(v.status=="not_found"){s("Proposal ID Not Found")}else{if(v.status=="complete"){u(v.tx_hash,v.tx)}else{s("Unknown status "+v.status)}}}};r._pollForCompleted(t,s)}}};this.newOffer=function(){return{offered_outpoints:[],request_outputs:[],offer_id:0,fee_percent:BigInteger.ZERO,toString:function(){var s=this;var x="---- OFFER ----\n";x+="Fee Percent "+s.fee_percent+"\n";x+="Actual Fee "+s.calculateFee()+"\n";x+="ID "+s.offer_id+"\n";x+="Inputs [\n";for(var t in s.offered_outpoints){var w=s.offered_outpoints[t];if(w.hash==null){var r=new Script(Crypto.util.hexToBytes(w.script));var v=[];r.extractAddresses(v);x+="    Awaiting Connection (Address "+v[0]+")"}else{x+="    Hash : "+w.hash}x+=" Value : "+w.value;x+="\n"}x+="]\n";x+="Outputs [\n";for(var t in s.request_outputs){var u=s.request_outputs[t];var r=new Script(Crypto.util.hexToBytes(u.script));var v=[];r.extractAddresses(v);x+="    Address : "+v[0]+" Value : "+u.value;if(u.exclude_from_fee){x+=" Change Output"}x+="\n"}x+="]\n";x+="---- END OFFER ----";return x},submit:function(u,t,r){var s=this;MyWallet.setLoadingText("Submitting Offer");$.retryAjax({dataType:"json",type:"POST",url:k,timeout:c,retryLimit:h,data:{method:"submit_offer",fee_percent:s.fee_percent.toString(),format:"json",token:d.getToken(),offer:JSON.stringify(s)},success:function(v){if(v.status=="complete"){r(v.tx_hash,v.tx)}else{if(!v.offer_id){t("Null offer_id returned")}else{s.offer_id=v.offer_id;u()}}},error:function(v){t(v.responseText)}})},_pollForProposalID:function(t,s){var r=this;console.log("Offer._pollForProposalID()");MyWallet.setLoadingText("Waiting For Other Participants");$.retryAjax({dataType:"json",type:"POST",url:k,timeout:c,retryLimit:h,data:{method:"get_offer_id",format:"json",offer_id:r.offer_id},success:function(u){t(u)},error:function(u){s(u.responseText)}})},calculateFee:function(){var r=this;var u=BigInteger.ZERO;for(var s in r.offered_outpoints){u=u.add(BigInteger.valueOf(r.offered_outpoints[s].value))}var t=BigInteger.ZERO;for(var s in r.request_outputs){t=t.add(BigInteger.valueOf(r.request_outputs[s].value))}return u.subtract(t)},pollForProposalID:function(u,s){var r=this;var t=function(v){if(v.status=="waiting"){r._pollForProposalID(t,s)}else{if(v.status=="not_found"){s("Offer ID Not Found")}else{if(v.status=="active_proposal"){u(v.proposal_id)}else{s("Unknown status "+v.status)}}}};r._pollForProposalID(t,s)},getProposal:function(u,v,t,r){var s=this;console.log("SharedCoin.getProposal()");MyWallet.setLoadingText("Fetching Proposal");$.retryAjax({dataType:"json",type:"POST",url:k,timeout:c,retryLimit:h,data:{method:"get_proposal_id",format:"json",offer_id:s.offer_id,proposal_id:u},success:function(x){var w=d.newProposal();var y=jQuery.extend(w,x);if(y.status=="not_found"){t("Proposal or Offer ID Not Found")}else{if(y.status=="complete"){r(y.tx_hash,y.tx)}else{if(y.status=="signatures_needed"){v(y)}else{if(y.status=="waiting"){s.getProposal(u,v,t,r)}else{t("Unknown get_proposal_id status")}}}}},error:function(w){t(w.responseText)}})},isOutpointOneWeOffered:function(s){var r=this;var u=s.outpoint.hash;var x=Crypto.util.bytesToHex(Crypto.util.base64ToBytes(u).reverse());var t=s.outpoint.index;for(var v in r.offered_outpoints){var w=r.offered_outpoints[v];if(w.hash.toString()==x.toString()&&w.index.toString()==t.toString()){return true}}return false},isOutputOneWeRequested:function(t){var s=this;var x=t.value.slice(0);x.reverse();var r=Crypto.util.bytesToHex(t.script.buffer);var w=new BigInteger(x);for(var u in s.request_outputs){var v=s.request_outputs[u];if(v.script.toString()==r.toString()&&w.toString()==v.value.toString()){return true}}return false},isOutputChange:function(t){var s=this;var x=t.value.slice(0);x.reverse();var r=Crypto.util.bytesToHex(t.script.buffer);var w=new BigInteger(x);for(var u in s.request_outputs){var v=s.request_outputs[u];if(v.script.toString()==r.toString()&&w.toString()==v.value.toString()){return v.exclude_from_fee}}return false},determineOutputsToOfferNextStage:function(C,x,B,y){var D=this;try{var s=Crypto.util.hexToBytes(x);var u=Bitcoin.Transaction.deserialize(s);var z=[];for(var t=0;t<u.outs.length;++t){var r=u.outs[t];if(D.isOutputOneWeRequested(r)){if(!D.isOutputChange(r)){var w=r.value.slice(0);w.reverse();var A=new BigInteger(w);z.push({script:Crypto.util.bytesToHex(r.script.buffer),hash:C,index:parseInt(t),value:A.toString()})}}}B(z)}catch(v){y(v)}},checkProposal:function(y,A,z){console.log("Offer.checkProposal()");var C=this;try{if(y.tx==null){throw"Proposal Transaction Is Null"}var u=Crypto.util.hexToBytes(y.tx);var w=Bitcoin.Transaction.deserialize(u);if(w==null){throw"Error deserializing transaction"}var B=0;for(var v=0;v<w.outs.length;++v){var t=w.outs[v];if(C.isOutputOneWeRequested(t)){++B}}if(B<C.request_outputs.length){throw"Could not find all our requested outputs ("+B+" < "+C.request_outputs.length+")"}var s=0;for(var v=0;v<y.signature_requests.length;++v){var r=y.signature_requests[v].tx_input_index;if(C.isOutpointOneWeOffered(w.ins[r])){++s}}if(C.offered_outpoints.length!=s){throw"Could not find all our offered outpoints ("+C.offered_outpoints.length+" != "+s+")"}A(w)}catch(x){z(x)}},signNormal:function(r,v,x,u){console.log("Offer.signNormal()");var t=0;var w=[];var s=function(){setTimeout(function(){try{var y=v[t];if(y==null){throw"Null connected script"}var A=signInput(r,y.tx_input_index,y.priv_to_use,y,SIGHASH_ALL);if(A){t++;w.push({tx_input_index:y.tx_input_index,input_script:Crypto.util.bytesToHex(A.buffer),offer_outpoint_index:y.offer_outpoint_index});if(t==v.length){x(w)}else{s()}}else{throw"Unknown error signing transaction"}}catch(z){u(z)}},1)};s()},submitInputScripts:function(u,v,w,t,r){console.log("Offer.submitInputScripts()");var s=this;MyWallet.setLoadingText("Submitting Signatures");p=new Date().getTime();$.retryAjax({dataType:"json",type:"POST",url:k,timeout:c,retryLimit:h,data:{method:"submit_signatures",format:"json",input_scripts:JSON.stringify(v),offer_id:s.offer_id,proposal_id:u.proposal_id},success:function(x){if(x.status=="not_found"){t("Proposal Expired or Not Found")}else{if(x.status=="verification_failed"){t("Signature Verification Failed")}else{if(x.status=="complete"){r(x.tx_hash,x.tx)}else{if(x.status=="signatures_accepted"){w("Signatures Accepted")}else{t("Unknown status "+x.status)}}}}},error:function(x){t(x.responseText)}})},signInputs:function(z,w,C,A){console.log("Offer.signInputs()");var D=this;try{var x={};var s=[];for(var v=0;v<z.signature_requests.length;++v){var u=z.signature_requests[v];var B=new Bitcoin.Script(Crypto.util.hexToBytes(u.connected_script));if(B==null){throw"signInputs() Connected script is null"}B.tx_input_index=u.tx_input_index;B.offer_outpoint_index=u.offer_outpoint_index;var r=B.simpleOutPubKeyHash();var t=new Bitcoin.Address(r).toString();if(x[t]){B.priv_to_use=x[t]}else{if(f[t]){B.priv_to_use=Bitcoin.Base58.decode(f[t])}else{if(MyWallet.addressExists(t)&&!MyWallet.isWatchOnly(t)){B.priv_to_use=MyWallet.decodePK(MyWallet.getPrivateKey(t))}}}if(B.priv_to_use==null){throw"Private key not found"}else{x[t]=B.priv_to_use}s.push(B)}D.signNormal(w,s,function(E){C(E)},function(E){A(E)})}catch(y){A(y)}}}};this.generateAddressAndKeyFromCustomSeed=function(s,v){var u=Crypto.SHA256(s+v,{asBytes:true});var t=new Bitcoin.ECKey(u);if(s.indexOf(b)==0){var r=t.getBitcoinAddressCompressed()}else{if(u[0]%2==0){var r=t.getBitcoinAddress()}else{var r=t.getBitcoinAddressCompressed()}}return{address:r,key:t}};this.generateAddressFromCustomSeed=function(s,t){var r=this.generateAddressAndKeyFromCustomSeed(s,t);f[r.address.toString()]=Bitcoin.Base58.encode(r.key.priv);return r.address};this.newPlan=function(){return{offers:[],n_stages:0,c_stage:0,address_seed:null,address_seen_n:0,generated_addresses:[],fee_percent_each_repetition:[],fee_each_repetition:[],to_addresses:{},generateAddressFromSeed:function(){if(this.address_seed==null){MyWallet._seed();var s=new Array(18);new SecureRandom().nextBytes(s);this.address_seed=Crypto.util.bytesToHex(s);MyWallet.addAdditionalSeeds(b+this.address_seed)}if(this.address_seen_n>=100){throw"Generating An Address Seed Greater than 100 Index. Please file an issue on Shared Coin github"}var r=d.generateAddressFromCustomSeed(b+this.address_seed,this.address_seen_n);this.address_seen_n++;return r},sanityCheck:function(E,y){try{var H=this;if(H.offers.length==0){throw"No Offers"}var r=BigInteger.valueOf(d.getMinimumFee());for(var t in H.offers){var B=H.offers[t];var G=BigInteger.ZERO;var F=BigInteger.ZERO;if(B.offered_outpoints.length>d.getMaximumOfferNumberOfInputs()){throw"Number of inputs greater than maximum"}for(var D in B.offered_outpoints){var C=B.offered_outpoints[D];if(C.value<d.getMinimumInputValue()){throw"Input value less than minimum"}if(C.value>d.getMaximumInputValue()){throw"Input value greater than maximum"}G=G.add(BigInteger.valueOf(C.value))}if(B.request_outputs.length>d.getMaximumOfferNumberOfOutputs()){throw"Number of outputs greater than maximum"}for(var D in B.request_outputs){var w=B.request_outputs[D];if(!w.script){throw"Output script null"}if(w.value<=0){throw"Output value <= 0"}if(w.exclude_from_fee){if(w.value<d.getMinimumOutputValueExcludingFee()){throw"Output value less than minimum value excluding fee"}}else{if(w.value<d.getMinimumOutputValue()){throw"Output value less than minimum"}}if(w.value>d.getMaximumOutputValue()){throw"Output value greater than maximum"}var z=new Script(Crypto.util.hexToBytes(w.script));var s=[];z.extractAddresses(s);if(s.length>1){throw"Multiple output addresses"}var A=s[0].toString();var u=BigInteger.valueOf(w.value);if(H.to_addresses[A]){if(H.to_addresses[A].compareTo(u)!=0){throw"Wrong Value Sent To "+A}else{delete H.to_addresses[A]}}else{if(MyWallet.addressExists(A)){}else{if(f[A]){}else{throw"Unknown Address "+A}}}F=F.add(u)}if(G.compareTo(F)<0){throw"valueInput < valueOutput"}var x=G.subtract(F);if(x.compareTo(r)<0){throw"Fee is too small"}if(x.compareTo(BigInteger.valueOf(satoshi))>0){throw"Fee seems unusually large"}}if(m(H.to_addresses)!=0){throw"Some recipient outputs missing"}E()}catch(v){console.log(v);y("Sanity Check Failed "+v+" : Please report to developers")}},toString:function(){var r=this;var t="----- PLAN -----\n";t+="fee_percent_each_repetition "+r.fee_percent_each_repetition+"\n";t+="fee_each_repetition "+r.fee_each_repetition+"\n";t+="address_seen_n "+r.address_seen_n+"\n";t+="address_seed "+r.address_seed+"\n";t+="generated_addresses "+r.generated_addresses+"\n";t+="Offers [\n";for(var s in r.offers){t+=o(r.offers[s].toString())+"\n"}t+="]\n";t+="----- END PLAN -----";return t},generateChangeAddress:function(){var s=MyWallet.generateNewKey();if(!s||!s.addr){throw"Error Generating Change Address"}var r=s.addr;this.generated_addresses.push(r);return new Bitcoin.Address(r)},executeOffer:function(t,u,s){function r(w,v){console.log("executeOffer.complete");t.determineOutputsToOfferNextStage(w,v,function(x){console.log(x);u(x)},s)}t.submit(function(){console.log("Successfully Submitted Offer");t.pollForProposalID(function(v){console.log("Proposal ID "+v);t.getProposal(v,function(w){console.log("Got Proposal");t.checkProposal(w,function(x){console.log("Proposal Looks Good");t.signInputs(w,x,function(y){console.log("Inputs Signed");t.submitInputScripts(w,y,function(z){console.log("Submitted Input Scripts");w.pollForCompleted(r,s)},s,r)},s)},s)},s,r)},s)},s,r)},execute:function(u,s){var r=this;var t=function(w){r.c_stage=w;var y=r.offers[w];console.log("Executing Stage "+w);var x=function(E){try{w++;if(w<r.n_stages){var C=r.offers[w];for(var A in E){var G=E[A];for(var B in C.offered_outpoints){var F=C.offered_outpoints[B];console.log(G.script);console.log(F.script);console.log(G.value);console.log(F.value);if(G.script==F.script&&G.value==F.value){$.extend(F,G);break}}}t(w)}else{if(w==r.n_stages){u()}}}catch(D){s(D)}};for(var z in y.offered_outpoints){var v=y.offered_outpoints[z];if(!v.hash){throw"Failed to connect input "+w}}r.executeOffer(y,x,function(A){console.log("executeOffer failed "+A);setTimeout(function(){r.executeOffer(y,x,s)},5000)})};MyWallet.backupWallet("update",function(){console.log("Saved Wallet");var y=MyWallet.getAdditionalSeeds();var x=false;for(var w in y){var v=y[w];if(v.indexOf(r.address_seed)>=0){x=true;break}}if(!x){s("Address Seed Not Found")}else{t(0)}},s)},constructRepetitions:function(X,aa,R,E){try{var w=this;var C=BigInteger.ZERO;for(var T in X.offered_outpoints){C=C.add(BigInteger.valueOf(X.offered_outpoints[T].value))}var Q=C.subtract(aa);var s=aa;X.fee_percent=w.fee_percent_each_repetition[w.n_stages-1];var W=[10,5,1,0.5,0.3,0.1,0.05];var G=15;var I;for(var L=0;L<w.n_stages-1;++L){var D=d.newOffer();if(L==0){D.offered_outpoints=X.offered_outpoints.slice(0);X.offered_outpoints=[]}else{for(var U in I.request_outputs){var F=I.request_outputs[U];if(!F.exclude_from_fee){D.offered_outpoints.push(F)}}}D.fee_percent=w.fee_percent_each_repetition[L];Q=Q.subtract(w.fee_each_repetition[L]);var K=8;var J=Math.random();if(Q.intValue()>=0.05*satoshi){var x=2;if(Q.intValue()>=0.1*satoshi&&J>=0.5){x=3}}else{var x=1}var N=BigInteger.ZERO;if(s.compareTo(BigInteger.ZERO)<0){throw"totalChangeValueLeftToConsume < 0"}else{if(s.compareTo(BigInteger.ZERO)>0){var S=Math.min(Math.max(w.n_stages-2,1),3);var A=(100/S)*((Math.random()*0.5)+0.75);N=aa.divide(BigInteger.valueOf(100)).multiply(BigInteger.valueOf(Math.ceil(A)))}}if(N.compareTo(BigInteger.valueOf(d.getMinimumOutputValue()))<=0||s.subtract(N).compareTo(BigInteger.valueOf(d.getMinimumOutputValue()))<=0){N=s;s=BigInteger.ZERO}else{s=s.subtract(N)}if(s.compareTo(BigInteger.ZERO)<0){throw"totalChangeValueLeftToConsume < 0"}var Y=Q.add(s);var v=false;for(var U=0;U<1000;++U){for(var M in W){var y=(W[M]/100)*((Math.random()*(G*2))-G);var O=BigInteger.valueOf(Math.round((W[M]+y)*satoshi));var t=Y.divideAndRemainder(O);var Z=t[0].intValue();if(Z>d.getMaximumOfferNumberOfOutputs()){continue}if(Z>=x&&Z<=K){if(t[1].compareTo(BigInteger.ZERO)==0||t[1].compareTo(BigInteger.valueOf(d.getMinimumOutputValue()))>=0){var H=[];if(t[1].compareTo(BigInteger.ZERO)>0){if(Z<=1){if(t[1].compareTo(d.getMinimumInputValue())<0||t[1].compareTo(d.getMaximumOutputValue())>0){continue}var r=w.generateAddressFromSeed();D.request_outputs.push({value:t[1].toString(),script:Crypto.util.bytesToHex(Script.createOutputScript(r).buffer)})}else{H=i(t[1].intValue(),Z)}}var z=true;for(var B=0;B<Z;++B){var P=O;if(H[B]&&H[B]>0){P=P.add(BigInteger.valueOf(H[B]))}if(P.compareTo(d.getMinimumInputValue())<0||P.compareTo(d.getMaximumOutputValue())>0){z=false;break}}if(!z){continue}for(var B=0;B<Z;++B){var r=w.generateAddressFromSeed();var P=O;if(H[B]&&H[B]>0){P=P.add(BigInteger.valueOf(H[B]))}D.request_outputs.push({value:P.toString(),script:Crypto.util.bytesToHex(Script.createOutputScript(r).buffer)})}v=true;break}}}if(v){break}}if(!v){var r=w.generateAddressFromSeed();D.request_outputs.push({value:Y.toString(),script:Crypto.util.bytesToHex(Script.createOutputScript(r).buffer)})}if(N.compareTo(BigInteger.ZERO)>0){var u=w.generateChangeAddress();if(N.compareTo(BigInteger.valueOf(d.getMinimumOutputValueExcludingFee()))<0){throw"Change Value Too Small 0 ("+N.toString()+" < "+d.getMinimumOutputValueExcludingFee()+")"}D.request_outputs.push({value:N.toString(),script:Crypto.util.bytesToHex(Script.createOutputScript(u).buffer),exclude_from_fee:true})}w.offers.push(D);I=D}for(var U in I.request_outputs){var F=I.request_outputs[U];if(!F.exclude_from_fee){X.offered_outpoints.push(F)}}if(s.compareTo(BigInteger.ZERO)>0){var u=w.generateChangeAddress();if(s.compareTo(BigInteger.valueOf(d.getMinimumOutputValueExcludingFee()))<0){throw"Change Value Too Small 1 ("+s.toString()+" < "+d.getMinimumOutputValueExcludingFee()+")"}X.request_outputs.push({value:s.toString(),script:Crypto.util.bytesToHex(Script.createOutputScript(u).buffer),exclude_from_fee:true})}w.offers.push(X);R(w)}catch(V){E(V)}}}};this.getMaximumOfferNumberOfInputs=function(){return q.maximum_offer_number_of_inputs};this.getMaximumOfferNumberOfOutputs=function(){return q.maximum_offer_number_of_outputs};this.getMinimumOutputValue=function(){return q.minimum_output_value};this.getMinimumOutputValueExcludingFee=function(){return q.minimum_output_value_exclude_fee};this.getToken=function(){return q.token};this.getMinimumInputValue=function(){return q.minimum_input_value};this.getMaximumInputValue=function(){return q.maximum_input_value};this.getMinimumSupportedVersion=function(){return q.min_supported_version};this.getIsEnabled=function(){return q.enabled};this.getMaximumOutputValue=function(){return q.maximum_output_value};this.getFee=function(){return q.fee_percent};this.getMinimumFee=function(){return q.minimum_fee?q.minimum_fee:0};this.constructPlan=function(u,A,M){try{var H=this;var N=u.find('select[name="repetitions"]');var t=u.find('input[name="shared-coin-donate"]').is(":checked");var C=parseInt(N.val());if(C<=0){throw"invalid number of repetitions"}console.log("constructPlan() Number Of Repetitions "+C+" Donate "+t);var v=d.newPlan();function x(V){for(var U in v.generated_addresses){MyWallet.deleteAddress(v.generated_addresses[U])}M(V)}var Q=initNewTx();Q.from_addresses=MyWallet.getActiveAddresses();var B=u.find(".recipient");if(B.length>d.getMaximumOfferNumberOfOutputs()){throw"The Maximum Number Of Recipients is "+d.getMaximumOfferNumberOfOutputs()}var F={};B.each(function(){try{var ab=$(this);var Z=ab.find('input[name="send-value"]');var W=ab.find('input[name="send-to-address"]');var X=0;try{X=precisionToSatoshiBN(Z.val());if(X==null||X.compareTo(BigInteger.ZERO)<=0){throw"You must enter a value greater than zero"}}catch(Y){throw"Invalid send amount"}if(X.compareTo(BigInteger.valueOf(d.getMinimumOutputValue()))<0){throw"Output Value Too Small"}var U=$.trim(W.val()).replace(/[\u200B-\u200D\uFEFF]/g,"");if(U==null||U.length==0){throw"You must enter a bitcoin address for each recipient"}var V=resolveAddress(U);if(V==null||V.length==0){throw"You must enter a bitcoin address for each recipient"}if(F[V]){throw"Shared Coin does not support multiple outputs to the same recipient"}F[V]=true;var aa=new Bitcoin.Address(V);if(aa.version!=0){throw"Shared Coin only supports sending payments to regular bitcoin addresses"}Q.to_addresses.push({address:aa,value:X});v.to_addresses[V]=X}catch(Y){x(Y)}});if(Q.to_addresses.length==0||Q.to_addresses.length<B.length){return}var r=[];var y=[];var P=[];var K=[];if(t){var S=(Math.random()*(n-g))+g;var J=(S/2)*((Math.random()*1.8)+0.2);J=J.toFixed(4);K.push(J);K.push(S-J)}for(var O in Q.to_addresses){var T=Q.to_addresses[O];r.push(T.value);for(var E=C-1;E>=0;--E){var z=d.getFee();if(K.length>0){z+=K.pop()}P[E]=z;var I=d.calculateFeeForValue(z,T.value);T.value=T.value.add(I);var G=y[E];if(G){y[E]=G.add(I)}else{y[E]=I}}}var D="1BitcoinEaterAddressDontSendf59kuE";Q.min_input_confirmations=1;Q.do_not_use_unspent_cache=true;Q.allow_adjust=false;Q.change_address=new Bitcoin.Address(D);Q.base_fee=BigInteger.ZERO;Q.min_input_size=BigInteger.valueOf(d.getMinimumInputValue());Q.fee=BigInteger.ZERO;Q.ask_for_fee=function(V,U){U()};function w(U){var Y={};var X={};for(var W in U){var V=U[W];var Z=new Bitcoin.Address(V.script.simpleOutPubKeyHash()).toString();Y[Z]=true;X[V.outpoint.hash]=true}return Math.min(m(Y),m(X))}var L=BigInteger.valueOf(satoshi);Q.isSelectedValueSufficient=function(W,X,U){var V=this;if(V.selected_outputs.length>=d.getMaximumOfferNumberOfInputs()){return true}if(X.compareTo(W.add(L))>=0&&w(U)>1){return true}return false};var s=d.newOffer();Q.addListener({on_error:function(U){x()}});Q.signInputs=function(){try{var af=this;if(af.tx.ins.length>d.getMaximumOfferNumberOfInputs()){x("Maximum number of inputs exceeded. Please consolidate some or lower the send amount");return}for(var X=0;X<af.tx.ins.length;++X){var ad=af.tx.ins[X];var V=ad.outpoint.hash;var ac=Crypto.util.bytesToHex(Crypto.util.base64ToBytes(V).reverse());s.offered_outpoints.push({hash:ac,index:ad.outpoint.index,value:ad.outpoint.value.toString()})}var Y=BigInteger.ZERO;for(var X=0;X<af.tx.outs.length;++X){var W=af.tx.outs[X];var ab=W.value.slice(0);ab.reverse();var ae=new BigInteger(ab);var U=new Bitcoin.Script(W.script).simpleOutPubKeyHash();var aa=new Bitcoin.Address(U).toString();if(aa.toString()==D){Y=Y.add(ae)}else{s.request_outputs.push({value:r[X].toString(),script:Crypto.util.bytesToHex(W.script.buffer)})}}if(Y.compareTo(BigInteger.ZERO)==0){throw"Transaction does not have any change. Shared Coin cannot send the exact amount available in the wallet."}v.n_stages=C;v.c_stage=0;v.fee_each_repetition=y;v.fee_percent_each_repetition=P;v.constructRepetitions(s,Y,A,function(ag){x(ag)})}catch(Z){x(Z)}};Q.start()}catch(R){x(R)}};this.calculateFeeForValue=function(v,s){var t=BigInteger.valueOf(d.getMinimumFee());if(s.compareTo(BigInteger.ZERO)>0&&v>0){var u=Math.ceil(100/v);var r=s.divide(BigInteger.valueOf(u));return t.add(r)}else{return t}};this.recoverSeeds=function(u,v,x){MyWallet.disableLogout(true);var y=$("#sharedcoin-recover-progress-modal");var r=y.find(".bar");y.modal("show");r.width("0%");var t=function(B){y.modal("hide");x(B)};var A=function(B){y.modal("hide");v(B)};var s=0;var z=0;function w(){if(!y.is(":visible")){return}if(s>=u.length){if(z>0){MyWallet.get_history();MyWallet.makeNotice("success","misc-success",formatBTC(z)+" recovered from intermediate addresses")}A();return}r.width(((s/u.length)*100)+"%");var D=u[s];++s;var F={};for(var E=0;E<100;++E){var C=d.generateAddressAndKeyFromCustomSeed(D,E);var B=C.address.toString();if(!MyWallet.addressExists(B)){F[B]=C.key}}BlockchainAPI.get_balances(Object.keys(F),function(J){try{var K=0;for(var H in J){var L=J[H].final_balance;if(L>0){console.log("Balance "+H+" = "+L);var G=F[H];var I=G.getBitcoinAddress().toString();try{if(MyWallet.addPrivateKey(G,{compressed:H!=I,app_name:IMPORTED_APP_NAME,app_version:IMPORTED_APP_VERSION})){console.log("Imported "+H)}}catch(M){console.log("Error importing "+H)}}K+=L}if(K>0){z+=K;MyWallet.backupWalletDelayed("update",function(){setTimeout(w,500)})}else{setTimeout(w,500)}}catch(M){t(M)}},t)}setTimeout(w,100)};this.init=function(v,t){if(!MyWallet.getSharedcoinEndpoint()||MyWallet.getSharedcoinEndpoint().length==0){(function(z,B,A){if(!B.is(":visible")){return}if(A>10){return}++A;setTimeout(function(){z.init(B)},2000)})(this,v,t);return}$("#sharedcoin-recover").unbind().click(function(){var z=$(this);MyWallet.getSecondPassword(function(){z.prop("disabled",true);var D=z.text();z.text("Working. Please Wait...");var E=MyWallet.getAdditionalSeeds();var A=[];for(var C in E){var B=E[C];if(B.indexOf(b)==0||B.indexOf(a)==0){A.push(B)}}A.reverse();d.recoverSeeds(A,function(){z.prop("disabled",false);z.text(D)},function(F){z.prop("disabled",false);z.text(D);MyWallet.makeNotice("error","misc-error",F)})})});var y=v.find(".send");var w=v.find(".send-options");var s=v.find('select[name="repetitions"]');y.unbind().prop("disabled",true);v.find('input[name="send-value"]').bind("keyup change",function(){r()});w.hide();function x(){var z=w.find("span");z.eq(0).text(formatBTC(d.getMaximumOutputValue()));z.eq(1).text(formatBTC(d.getMinimumOutputValue()));z.eq(2).text(d.getFee());z.eq(3).text(formatBTC(d.getMinimumFee()));w.show()}function u(){var z=BigInteger.ZERO;v.find('input[name="send-value"]').each(function(){z=z.add(precisionToSatoshiBN($(this).val()))});return z}function r(){y.unbind();var A=parseInt(s.val());if(A>0&&d.getIsEnabled()&&j>=d.getMinimumSupportedVersion()){var z=u();if(z.compareTo(BigInteger.valueOf(d.getMinimumOutputValue()))<0){y.prop("disabled",true)}else{if(z.compareTo(BigInteger.valueOf(d.getMaximumOutputValue()))>0){y.prop("disabled",true)}else{y.prop("disabled",false);y.unbind().click(function(){MyWallet.disableLogout(true);var B=function(E,D){console.log("Fatal Error");v.find("input,select,button").prop("disabled",false);r();MyWallet.disableLogout(false);MyWallet.makeNotice("error","misc-error",E,(D&&D.c_stage)>0?60000:10000);setTimeout(function(){if(D&&D.c_stage>=0){console.log("Recover Seeds");e.hide();d.recoverSeeds([b+D.address_seed],function(){e.show()},function(){e.show()})}},1000);e.enableCancel()};var C=function(){v.find("input,select,button").prop("disabled",false);MyWallet.makeNotice("success","misc-success","Shared Coin Transaction Successfully Completed");MyWallet.disableLogout(false);e.hide();r()};if(z.compareTo(BigInteger.valueOf(d.getMinimumOutputValue()))<0){MyWallet.makeNotice("error","misc-error","The Minimum Send Value is "+formatPrecision(d.getMinimumOutputValue()));return}else{if(z.compareTo(BigInteger.valueOf(d.getMaximumOutputValue()))>0){MyWallet.makeNotice("error","misc-error","The Maximum Send Value is "+formatPrecision(d.getMaximumOutputValue()));return}}MyWallet.getSecondPassword(function(){loadScript("wallet/signer",function(){e.show();e.disableCancel();var G=u();var E=v.find(".recipient");if(E.length==1){var H=E.find('input[name="send-to-address"]').val()}else{var H="Multiple Recipients"}e.setAddressAndAmount(H,G);v.find("input,select,button").prop("disabled",true);MyWallet.setLoadingText("Constructing Plan. Please Wait.");var D=new Date().getTime()-p;var F=Math.max(0,l-D);if(F>0){$(".loading-indicator").fadeIn(200)}setTimeout(function(){$(".loading-indicator").hide();d.constructPlan(v,function(I){console.log("Created Plan");console.log(I.toString());I.sanityCheck(function(){console.log("Sanity Check OK");I.execute(C,function(J){B(J,I)})},B)},B)},F)},B)},B)})}}}else{y.prop("disabled",true)}}MyWallet.setLoadingText("Fetching Shared Coin Info");$.retryAjax({dataType:"json",type:"POST",url:k,timeout:c,retryLimit:h,data:{method:"get_info",format:"json"},success:function(B){try{q=B;if(!d.getIsEnabled()){throw"Shared Coin is currently disabled"}if(j<d.getMinimumSupportedVersion()){throw"Version out of date. Please update your client or reload the page."}x();s.empty();for(var z=B.recommended_min_iterations;z<=B.recommended_max_iterations;z+=1){s.append('<option value="'+(z)+'">'+(z)+" Repetitions</option>")}s.val(B.recommended_iterations)}catch(A){MyWallet.makeNotice("error","misc-error",A)}r()},error:function(z){y.prop("disabled",true);MyWallet.makeNotice("error","misc-error",z.responseText)}});r()}};