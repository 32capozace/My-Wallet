var SharedCoin=new function(){var d=this;var c={};var b=2;var a=MyWallet.getSharedcoinEndpoint()+"?version="+b;this.newProposal=function(){return{_pollForCompleted:function(g,f){var e=this;console.log("Offer._pollForCompleted()");MyWallet.setLoadingText("Waiting For Others Participants To Sign");$.ajax({dataType:"json",type:"POST",url:a,data:{method:"poll_for_proposal_completed",format:"json",proposal_id:e.proposal_id},success:function(h){g(h)},error:function(h){f(h.responseText)}})},pollForCompleted:function(h,f){var e=this;var g=function(i){if(i.status=="waiting"){e._pollForCompleted(g,f)}else{if(i.status=="not_found"){f("Proposal ID Not Found")}else{if(i.status=="complete"){h(e)}else{f("Unknown status "+i.status)}}}};e._pollForCompleted(g,f)}}};this.newOffer=function(){return{offered_outpoints:[],request_outputs:[],offer_id:0,submit:function(g,f){var e=this;MyWallet.setLoadingText("Submitting Offer");$.ajax({dataType:"json",type:"POST",url:a,data:{method:"submit_offer",format:"json",offer:JSON.stringify(e)},success:function(h){if(!h.offer_id){f("Null offer_id returned")}else{e.offer_id=h.offer_id;g()}},error:function(h){f(h.responseText)}})},_pollForProposalID:function(g,f){var e=this;console.log("Offer._pollForProposalID()");MyWallet.setLoadingText("Waiting For Other Participants");$.ajax({dataType:"json",type:"POST",url:a,data:{method:"get_offer_id",format:"json",offer_id:e.offer_id},success:function(h){g(h)},error:function(h){f(h.responseText)}})},calculateFee:function(){var e=this;var h=BigInteger.ZERO;for(var f in e.offered_outpoints){h=h.add(BigInteger.valueOf(e.offered_outpoints[f].value))}var g=BigInteger.ZERO;for(var f in e.request_outputs){g=g.add(BigInteger.valueOf(e.request_outputs[f].value))}return h.subtract(g)},pollForProposalID:function(h,f){var e=this;var g=function(i){if(i.status=="waiting"){e._pollForProposalID(g,f)}else{if(i.status=="not_found"){f("Offer ID Not Found")}else{if(i.status=="active_proposal"){h(i.proposal_id)}else{f("Unknown status "+i.status)}}}};e._pollForProposalID(g,f)},getProposal:function(g,h,f){var e=this;console.log("SharedCoin.getProposal()");MyWallet.setLoadingText("Fetching Proposal");$.ajax({dataType:"json",type:"POST",url:a,data:{method:"get_proposal_id",format:"json",offer_id:e.offer_id,proposal_id:g},success:function(j){var i=d.newProposal();var k=jQuery.extend(i,j);if(k.status=="not_found"){f("Proposal or Offer ID Not Found")}else{h(k)}},error:function(i){f(i.responseText)}})},isOutpointOneWeOffered:function(f){var e=this;var h=f.outpoint.hash;var k=Crypto.util.bytesToHex(Crypto.util.base64ToBytes(h).reverse());var g=f.outpoint.index;for(var i in e.offered_outpoints){var j=e.offered_outpoints[i];if(j.hash.toString()==k.toString()&&j.index.toString()==g.toString()){return true}}return false},isOutputOneWeRequested:function(g){var f=this;var k=g.value.slice(0);k.reverse();var e=Crypto.util.bytesToHex(g.script.buffer);var j=new BigInteger(k);for(var h in f.request_outputs){var i=f.request_outputs[h];if(i.script.toString()==e.toString()&&j.toString()==i.value.toString()){return true}}return false},checkProposal:function(m,p,n){console.log("Offer.checkProposal()");var r=this;try{if(m.tx==null){throw"Proposal Transaction Is Null"}var h=Crypto.util.hexToBytes(m.tx);Bitcoin.Transaction.deserialize=function(z){var B=new Bitcoin.Transaction();B.version=readUInt32(z);var v=readVarInt(z).intValue();for(var A=0;A<v;A++){var w=z.splice(0,32);var t=Crypto.util.bytesToBase64(w);var e=readUInt32(z);var y=readVarInt(z).intValue();var C=new Bitcoin.Script(z.splice(0,y));var u=readUInt32(z);var D=new Bitcoin.TransactionIn({outpoint:{hash:t,index:e},script:C,sequence:u});B.ins.push(D)}var E=readVarInt(z).intValue();for(var A=0;A<E;A++){var s=z.splice(0,8);var y=readVarInt(z).intValue();var C=new Bitcoin.Script(z.splice(0,y));var x=new Bitcoin.TransactionOut({script:C,value:s});B.outs.push(x)}B.lock_time=readUInt32(z);return B};var k=Bitcoin.Transaction.deserialize(h);if(k==null){throw"Error deserializing transaction"}var o=[];var q=0;for(var j=0;j<k.outs.length;++j){if(r.isOutputOneWeRequested(k.outs[j])){o.push({hash:Crypto.util.bytesToHex(k.getHash()),index:parseInt(j),value:k.outs[j].value.toString()});++q}}if(q<r.request_outputs.length){throw"Could not find all our requested outputs ("+q+" < "+r.request_outputs.length+")"}var g=0;for(var j=0;j<m.signature_requests.length;++j){var f=m.signature_requests[j].tx_input_index;if(r.isOutpointOneWeOffered(k.ins[f])){++g}}if(r.offered_outpoints.length!=g){throw"Could not find all our offered outpoints ("+r.offered_outpoints.length+" != "+g+")"}p(k,o)}catch(l){n(l)}},signNormal:function(e,i,k,h){console.log("Offer.signNormal()");var g=0;var j=[];var f=function(){setTimeout(function(){try{var l=i[g];var n=signInput(e,l.tx_input_index,l.priv_to_use,l,SIGHASH_ALL);if(n){g++;j.push({tx_input_index:l.tx_input_index,input_script:Crypto.util.bytesToHex(n.buffer),offer_outpoint_index:l.offer_outpoint_index});if(g==i.length){k(j)}else{f()}}else{throw"Unknown error signing transaction"}}catch(m){h(m)}},1)};f()},submitInputScripts:function(g,h,i,f){console.log("Offer.submitInputScripts()");var e=this;MyWallet.setLoadingText("Submitting Signatures");$.ajax({dataType:"json",type:"POST",url:a,data:{method:"submit_signatures",format:"json",input_scripts:JSON.stringify(h),offer_id:e.offer_id,proposal_id:g.proposal_id},success:function(j){if(j.status=="not_found"){f("Proposal Expired or Not Found")}else{if(j.status=="verification_failed"){f("Signature Verification Failed")}else{if(j.status=="signatures_accepted"){i("Signatures Accepted")}else{f("Unknown status "+j.status)}}}},error:function(j){f(j.responseText)}})},signInputs:function(o,l,r,p){console.log("Offer.signInputs()");var s=this;try{var m={};var g=[];for(var k=0;k<o.signature_requests.length;++k){var j=o.signature_requests[k];var q=new Bitcoin.Script(Crypto.util.hexToBytes(j.connected_script));q.tx_input_index=j.tx_input_index;q.offer_outpoint_index=j.offer_outpoint_index;var f=q.simpleOutPubKeyHash();var h=new Bitcoin.Address(f).toString();if(m[h]){q.priv_to_use=m[h]}else{if(MyWallet.addressExists(h)&&!MyWallet.isWatchOnly(h)){q.priv_to_use=MyWallet.decodePK(MyWallet.getPrivateKey(h))}}if(q.priv_to_use==null){throw"Private key not found"}else{m[h]=q.priv_to_use}g.push(q)}s.signNormal(l,g,function(e){r(e)},function(i){p(i)})}catch(n){p(n)}}}};this.newPlan=function(){return{offers:[],n_stages:0,executeOffer:function(f,g,e){f.submit(function(){console.log("Successfully Submitted Offer");f.pollForProposalID(function(h){console.log("Proposal ID "+h);MyWallet.backupWallet("update",function(){console.log("Saved Wallet");f.getProposal(h,function(i){console.log("Got Proposal");f.checkProposal(i,function(j,k){console.log("Proposal Looks Good");f.signInputs(i,j,function(l){console.log("Inputs Signed");f.submitInputScripts(i,l,function(m){console.log("Submitted Input Scripts");i.pollForCompleted(function(){console.log("Poll For Completed Success");g(k)},function(n){e(n)})},function(m){e(m)})},function(l){e(l)})},function(j){e(j)})},function(i){e(i)})},function(i){e(i)})},function(h){e(h)})},function(h){e(h)})},execute:function(h,f){var e=this;var g=function(i){var j=e.offers[i];console.log("Executing Stage "+i);e.executeOffer(j,function(k){i++;if(i<e.n_stages){e.offers[i].offered_outpoints=k;g(i)}else{if(i==e.n_stages){h()}}},function(k){f(k)})};g(0)},constructRepetitions:function(n,q,s,o){try{var t=this;var h=BigInteger.ZERO;for(var k in n.offered_outpoints){h=h.add(BigInteger.valueOf(n.offered_outpoints[k].value))}var g=BigInteger.ZERO;for(var k in n.request_outputs){g=g.add(BigInteger.valueOf(n.request_outputs[k].value))}var m=n.calculateFee();console.log("Total feesAllocated "+m.toString());console.log("totalValueInput "+h.toString());var f=h;for(var r=0;r<t.n_stages-1;++r){var p=d.newOffer();if(r==0){for(var k in n.request_outputs){if(n.request_outputs[k].exclude_from_fee){var j=n.request_outputs.splice(k,1)[0];console.log(j);p.request_outputs.push(j);f=f.subtract(BigInteger.valueOf(j.value));break}}p.offered_outpoints=n.offered_outpoints.slice(0);n.offered_outpoints=[]}d.generateNewAddress(function(e){console.log(q[r].toString());f=f.subtract(q[r]);p.request_outputs.push({value:f.toString(),script:Crypto.util.bytesToHex(Script.createOutputScript(e).buffer)})},function(i){o(i)});console.log("Fee For Offer "+r+" "+p.calculateFee().toString());t.offers.push(p)}console.log("Fee For Final Offer "+n.calculateFee().toString());t.offers.push(n);s(t)}catch(l){o(l)}}}};this.generateNewAddress=function(j,f){try{var g=MyWallet.generateNewKey();var i=g.getBitcoinAddress();MyWallet.setAddressLabel(i.toString(),"SharedCoin Change");j(i)}catch(h){f(h)}};this.getMinimumOutputValue=function(){return c.minimum_output_value};this.getMinimumInputValue=function(){return c.minimum_input_value};this.getMinimumSupportedVersion=function(){return c.min_supported_version};this.getIsEnabled=function(){return c.enabled};this.getMaximumOutputValue=function(){return c.maximum_output_value};this.getFee=function(){return c.fee_percent};this.getMinimumFee=function(){return c.minimum_fee?c.minimum_fee:0};this.constructPlan=function(l,w,t){try{var h=l.find('select[name="repetitions"]');var p=parseInt(h.val());if(p<=0){throw"invalid number of repetitions"}var q=initNewTx();var f=l.find('select[name="from"]');var m=f.val();if(m==null||m=="any"){q.from_addresses=MyWallet.getActiveAddresses()}else{if(f.attr("multiple")=="multiple"){q.from_addresses=m}else{q.from_addresses=[m]}}var g=l.find(".recipient");g.each(function(){try{var C=$(this);var B=C.find('input[name="send-value"]');var y=C.find('input[name="send-to-address"]');var z=0;try{z=precisionToSatoshiBN(B.val());if(z==null||z.compareTo(BigInteger.ZERO)<=0){throw"You must enter a value greater than zero"}}catch(A){console.log(A);throw"Invalid send amount"}var i=$.trim(y.val()).replace(/[\u200B-\u200D\uFEFF]/g,"");if(i==null||i.length==0){throw"You must enter a bitcoin address for each recipient"}var x=resolveAddress(i);if(x==null||x.length==0){throw"You must enter a bitcoin address for each recipient"}q.to_addresses.push({address:new Bitcoin.Address(x),value:z})}catch(A){t(A)}});if(q.to_addresses.length==0||q.to_addresses.length<g.length){return}var k=[];var u=[];for(var o in q.to_addresses){var n=q.to_addresses[o];k.push(n.value);for(var v=0;v<p;++v){var s=d.calculateFeeForValue(n.value);n.value=n.value.add(s);var j=u[v];if(j){u[v]=j.add(s)}else{u[v]=s}}}d.generateNewAddress(function(e){q.min_input_confirmations=1;q.allow_adjust=false;q.change_address=e;q.base_fee=BigInteger.ZERO;q.min_input_size=BigInteger.valueOf(d.getMinimumInputValue());q.min_free_output_size=BigInteger.valueOf(d.getMinimumOutputValue());q.fee=BigInteger.ZERO;q.ask_for_fee=function(y,x){x()};var i=d.newOffer();q.signInputs=function(){try{var I=this;for(var A=0;A<I.tx.ins.length;++A){var G=I.tx.ins[A];var y=G.outpoint.hash;var F=Crypto.util.bytesToHex(Crypto.util.base64ToBytes(y).reverse());i.offered_outpoints.push({hash:F,index:G.outpoint.index,value:G.outpoint.value.toString()})}for(var A=0;A<I.tx.outs.length;++A){var z=I.tx.outs[A];var D=z.value.slice(0);D.reverse();var x=new Bitcoin.Script(z.script).simpleOutPubKeyHash();var C=new Bitcoin.Address(x).toString();var H=new BigInteger(D);if(C.toString()==e.toString()){i.request_outputs.push({value:H.toString(),script:Crypto.util.bytesToHex(z.script.buffer),exclude_from_fee:true})}else{i.request_outputs.push({value:k[A].toString(),script:Crypto.util.bytesToHex(z.script.buffer)})}}var E=d.newPlan();E.n_stages=p;E.c_stage=0;E.constructRepetitions(i,u,w,function(J){t(J)})}catch(B){t(B)}};q.addListener({on_error:function(x){t()}});q.start()},function(i){t(i)})}catch(r){MyWallet.makeNotice("error","misc-error",r)}};this.calculateFeeForValue=function(f){if(f.compareTo(BigInteger.ZERO)>0){var h=Math.ceil(100/d.getFee());var e=f.divide(BigInteger.valueOf(h));var g=BigInteger.valueOf(d.getMinimumFee());if(g.compareTo(e)>0){return g}else{return e}}else{return BigInteger.ZERO}};this.init=function(g){var j=g.find(".send");var h=g.find(".send-options");var f=g.find('select[name="repetitions"]');j.unbind().prop("disabled",true);g.find('input[name="send-value"]').bind("keyup change",function(){e()});h.hide();function i(){var k=h.find("span");k.eq(0).text(formatBTC(d.getMaximumOutputValue()));k.eq(1).text(formatBTC(d.getMinimumOutputValue()));k.eq(2).text(d.getFee());k.eq(3).text(formatBTC(d.getMinimumFee()));h.show()}function e(){var l=parseInt(f.val());if(l>0&&d.getIsEnabled()&&b>=d.getMinimumSupportedVersion()){var k=precisionToSatoshiBN(g.find('input[name="send-value"]').val());if(k.compareTo(BigInteger.valueOf(d.getMinimumOutputValue()))<0){j.prop("disabled",true)}else{if(k.compareTo(BigInteger.valueOf(d.getMaximumOutputValue()))>0){j.prop("disabled",true)}else{j.prop("disabled",false);j.unbind().click(function(){MyWallet.disableLogout(true);var m=function(n){MyWallet.disableLogout(false);g.find("input,select,button").prop("disabled",false);MyWallet.makeNotice("error","misc-error",n)};MyWallet.getSecondPassword(function(){loadScript("wallet/signer",function(){g.find("input,select,button").prop("disabled",true);d.constructPlan(g,function(n){console.log("Created Plan");console.log(n)},m)},m)},m)})}}}else{j.prop("disabled",true)}}MyWallet.setLoadingText("Fetching SharedCoin Info");$.ajax({dataType:"json",type:"POST",url:a,data:{method:"get_info",format:"json"},success:function(m){try{c=m;if(!d.getIsEnabled()){throw"Shared Coin is currently disabled"}if(b<d.getMinimumSupportedVersion()){throw"Version out of date. Please update your client or reload the page."}m.recommended_max_iterations=5;i();f.empty();for(var k=m.recommended_min_iterations;k<=m.recommended_max_iterations;k+=1){f.append('<option value="'+(k)+'">'+(k)+" Repetitions (Fee: "+((k)*d.getFee()).toFixed(3)+"%)</option>")}f.val(m.recommended_iterations)}catch(l){MyWallet.makeNotice("error","misc-error",l)}e()},error:function(k){j.prop("disabled",true);MyWallet.makeNotice("error","misc-error",k.responseText)}})}};