var SharedCoin=new function(){var o=this;var q=0.5;var r=1;var h=120000;var d=3;var l=0;var f=120000;var a={};var b=5;var g=MyWallet.getSharedcoinEndpoint()+"?version="+b;var n={};var i="sharedcoin-seed-v2:";var e="sharedcoin-seed:";var k=7;function m(u){var t=0,s;for(s in u){t++}return t}function j(v){var s=v.split("\n");var u="";for(var t in s){u+="     "+s[t]+"\n"}return u}(function(s){s.retryAjax=function(u){var t;u.tryCount=(!u.tryCount)?0:u.tryCount;u.retryLimit=(!u.retryLimit)?2:u.retryLimit;u.suppressErrors=true;if(u.error){t=u.error;delete u.error}else{t=function(){}}u.complete=function(v,w){if(s.inArray(w,["timeout","abort","error"])>-1){this.tryCount++;if(this.tryCount<=this.retryLimit){if(this.tryCount===this.retryLimit){this.error=t;delete this.suppressErrors}(function(x){setTimeout(function(){s.ajax(x)},5000)})(this);return true}return true}};s.ajax(u)}}(jQuery));Bitcoin.Transaction.deserialize=function(B){function t(K){var I,J;I=K.splice(0,1)[0];if(I<253){J=[I]}else{if(I==253){J=K.splice(0,2)}else{if(I==254){J=K.splice(0,4)}else{J=K.splice(0,8)}}}return BigInteger.fromByteArrayUnsigned(J)}function E(I){return new BigInteger(I.splice(0,4).reverse()).intValue()}var D=new Bitcoin.Transaction();D.version=E(B);var x=t(B).intValue();for(var C=0;C<x;C++){var y=B.splice(0,32);var v=Crypto.util.bytesToBase64(y);var s=E(B);var A=t(B).intValue();var F=new Bitcoin.Script(B.splice(0,A));var w=E(B);var G=new Bitcoin.TransactionIn({outpoint:{hash:v,index:s},script:F,sequence:w});D.ins.push(G)}var H=t(B).intValue();for(var C=0;C<H;C++){var u=B.splice(0,8);var A=t(B).intValue();var F=new Bitcoin.Script(B.splice(0,A));var z=new Bitcoin.TransactionOut({script:F,value:u});D.outs.push(z)}D.lock_time=E(B);return D};function c(w,z){var x=[];var s=Math.round(w*1/z);var y=Math.round(0.5*s);var u=0;for(var t=0;t<z;t++){var v=Math.floor((Math.random()*s)+y);if(u+v>w||t==z-1){v=w-u}u+=v;x[t]=v;if(u==w){break}}return x}var p={show:function(){var s=this;s.modal=$("#sharedcoin-modal");s.modal.modal({keyboard:false,backdrop:"static",show:true});s.modal.find(".btn.btn-secondary").unbind().click(function(){s.hide()})},setProgressError:function(){if(this.modal){var s=this.modal.find(".progress");s.addClass("progress-danger");s.removeClass("progress-success");s.removeClass("progress-info")}},setProgressSuccess:function(){if(this.modal){var s=this.modal.find(".progress");s.addClass("progress-success");s.removeClass("progress-danger");s.removeClass("progress-info")}},setProgressInfo:function(){if(this.modal){var s=this.modal.find(".progress");s.addClass("progress-info");s.removeClass("progress-success");s.removeClass("progress-danger")}},setProgress:function(t,v){if(this.modal){var u=(t/v)*100;var s=this.modal.find(".progress");if(t>=v){s.removeClass("active")}else{s.addClass("active")}s.children().css("width",u+"%")}},setAddressAndAmount:function(s,t){if(this.modal){this.modal.find(".total_value").text(formatBTC(t));this.modal.find(".address").text(s)}},hide:function(){if(this.modal){this.modal.modal("hide")}},disableCancel:function(){if(this.modal){this.modal.find(".alert-warning").show();this.modal.find(".alert-error").hide();this.modal.find(".btn.btn-secondary").prop("disabled",true)}},enableCancel:function(){if(this.modal){this.modal.find(".alert-error").show();this.modal.find(".alert-warning").hide();this.modal.find(".btn.btn-secondary").prop("disabled",false)}}};this.newProposal=function(){return{_pollForCompleted:function(u,t){var s=this;console.log("Offer._pollForCompleted()");MyWallet.setLoadingText("Waiting For Other Participants To Sign");$.retryAjax({dataType:"json",type:"POST",url:g,timeout:h,retryLimit:4,data:{method:"poll_for_proposal_completed",format:"json",proposal_id:s.proposal_id},success:function(v){u(v)},error:function(v){t(v.responseText)}})},pollForCompleted:function(v,t){var s=this;var u=function(w){if(w.status=="waiting"){s._pollForCompleted(u,t)}else{if(w.status=="not_found"){t("Proposal ID Not Found")}else{if(w.status=="complete"){v(w.tx_hash,w.tx)}else{t("Unknown status "+w.status)}}}};s._pollForCompleted(u,t)}}};this.newOffer=function(){return{offered_outpoints:[],request_outputs:[],offer_id:0,fee_percent:BigInteger.ZERO,toString:function(){var t=this;var y="---- OFFER ----\n";y+="Fee Percent "+t.fee_percent+"\n";y+="Actual Fee "+t.calculateFee()+"\n";y+="ID "+t.offer_id+"\n";y+="Inputs [\n";for(var u in t.offered_outpoints){var x=t.offered_outpoints[u];if(x.hash==null){var s=new Script(Crypto.util.hexToBytes(x.script));var w=[];s.extractAddresses(w);y+="    Awaiting Connection (Address "+w[0]+")"}else{y+="    Hash : "+x.hash}y+=" Value : "+x.value;y+="\n"}y+="]\n";y+="Outputs [\n";for(var u in t.request_outputs){var v=t.request_outputs[u];var s=new Script(Crypto.util.hexToBytes(v.script));var w=[];s.extractAddresses(w);y+="    Address : "+w[0]+" Value : "+v.value;if(v.exclude_from_fee){y+=" Change Output"}y+="\n"}y+="]\n";y+="---- END OFFER ----";return y},submit:function(v,u,s){var t=this;MyWallet.setLoadingText("Submitting Offer");$.retryAjax({dataType:"json",type:"POST",url:g,timeout:h,retryLimit:d,data:{method:"submit_offer",fee_percent:t.fee_percent.toString(),format:"json",token:o.getToken(),offer:JSON.stringify(t)},success:function(w){if(w.status=="complete"){s(w.tx_hash,w.tx)}else{if(!w.offer_id){u("Null offer_id returned")}else{t.offer_id=w.offer_id;v()}}},error:function(w){u(w.responseText)}})},_pollForProposalID:function(u,t){var s=this;console.log("Offer._pollForProposalID()");MyWallet.setLoadingText("Waiting For Other Participants");$.retryAjax({dataType:"json",type:"POST",url:g,timeout:h,retryLimit:d,data:{method:"get_offer_id",format:"json",offer_id:s.offer_id},success:function(v){u(v)},error:function(v){t(v.responseText)}})},calculateFee:function(){var s=this;var v=BigInteger.ZERO;for(var t in s.offered_outpoints){v=v.add(BigInteger.valueOf(s.offered_outpoints[t].value))}var u=BigInteger.ZERO;for(var t in s.request_outputs){u=u.add(BigInteger.valueOf(s.request_outputs[t].value))}return v.subtract(u)},pollForProposalID:function(v,t){var s=this;var u=function(w){if(w.status=="waiting"){s._pollForProposalID(u,t)}else{if(w.status=="not_found"){t("Offer ID Not Found")}else{if(w.status=="active_proposal"){v(w.proposal_id)}else{t("Unknown status "+w.status)}}}};s._pollForProposalID(u,t)},getProposal:function(v,w,u,s){var t=this;console.log("SharedCoin.getProposal()");MyWallet.setLoadingText("Fetching Proposal");$.retryAjax({dataType:"json",type:"POST",url:g,timeout:h,retryLimit:d,data:{method:"get_proposal_id",format:"json",offer_id:t.offer_id,proposal_id:v},success:function(y){var x=o.newProposal();var z=jQuery.extend(x,y);if(z.status=="not_found"){u("Proposal or Offer ID Not Found")}else{if(z.status=="complete"){s(z.tx_hash,z.tx)}else{if(z.status=="signatures_needed"){w(z)}else{if(z.status=="waiting"){t.getProposal(v,w,u,s)}else{u("Unknown get_proposal_id status")}}}}},error:function(x){u(x.responseText)}})},isOutpointOneWeOffered:function(t){var s=this;var v=t.outpoint.hash;var y=Crypto.util.bytesToHex(Crypto.util.base64ToBytes(v).reverse());var u=t.outpoint.index;for(var w in s.offered_outpoints){var x=s.offered_outpoints[w];if(x.hash.toString()==y.toString()&&x.index.toString()==u.toString()){return true}}return false},isOutputOneWeRequested:function(u){var t=this;var y=u.value.slice(0);y.reverse();var s=Crypto.util.bytesToHex(u.script.buffer);var x=new BigInteger(y);for(var v in t.request_outputs){var w=t.request_outputs[v];if(w.script.toString()==s.toString()&&x.toString()==w.value.toString()){return true}}return false},isOutputChange:function(u){var t=this;var y=u.value.slice(0);y.reverse();var s=Crypto.util.bytesToHex(u.script.buffer);var x=new BigInteger(y);for(var v in t.request_outputs){var w=t.request_outputs[v];if(w.script.toString()==s.toString()&&x.toString()==w.value.toString()){return w.exclude_from_fee}}return false},determineOutputsToOfferNextStage:function(D,y,C,z){var E=this;try{var t=Crypto.util.hexToBytes(y);var v=Bitcoin.Transaction.deserialize(t);var A=[];for(var u=0;u<v.outs.length;++u){var s=v.outs[u];if(E.isOutputOneWeRequested(s)){if(!E.isOutputChange(s)){var x=s.value.slice(0);x.reverse();var B=new BigInteger(x);A.push({script:Crypto.util.bytesToHex(s.script.buffer),hash:D,index:parseInt(u),value:B.toString()})}}}C(A)}catch(w){z(w)}},checkProposal:function(z,B,A){console.log("Offer.checkProposal()");var D=this;try{if(z.tx==null){throw"Proposal Transaction Is Null"}var v=Crypto.util.hexToBytes(z.tx);var x=Bitcoin.Transaction.deserialize(v);if(x==null){throw"Error deserializing transaction"}var C=0;for(var w=0;w<x.outs.length;++w){var u=x.outs[w];if(D.isOutputOneWeRequested(u)){++C}}if(C<D.request_outputs.length){throw"Could not find all our requested outputs ("+C+" < "+D.request_outputs.length+")"}var t=0;for(var w=0;w<z.signature_requests.length;++w){var s=z.signature_requests[w].tx_input_index;if(D.isOutpointOneWeOffered(x.ins[s])){++t}}if(D.offered_outpoints.length!=t){throw"Could not find all our offered outpoints ("+D.offered_outpoints.length+" != "+t+")"}B(x)}catch(y){A(y)}},signNormal:function(s,w,y,v){console.log("Offer.signNormal()");var u=0;var x=[];var t=function(){setTimeout(function(){try{var z=w[u];if(z==null){throw"Null connected script"}var B=signInput(s,z.tx_input_index,z.priv_to_use,z,SIGHASH_ALL);if(B){u++;x.push({tx_input_index:z.tx_input_index,input_script:Crypto.util.bytesToHex(B.buffer),offer_outpoint_index:z.offer_outpoint_index});if(u==w.length){y(x)}else{t()}}else{throw"Unknown error signing transaction"}}catch(A){v(A)}},1)};t()},submitInputScripts:function(v,w,x,u,s){console.log("Offer.submitInputScripts()");var t=this;MyWallet.setLoadingText("Submitting Signatures");l=new Date().getTime();$.retryAjax({dataType:"json",type:"POST",url:g,timeout:h,retryLimit:d,data:{method:"submit_signatures",format:"json",input_scripts:JSON.stringify(w),offer_id:t.offer_id,proposal_id:v.proposal_id},success:function(y){if(y.status=="not_found"){u("Proposal Expired or Not Found")}else{if(y.status=="verification_failed"){u("Signature Verification Failed")}else{if(y.status=="complete"){s(y.tx_hash,y.tx)}else{if(y.status=="signatures_accepted"){x("Signatures Accepted")}else{u("Unknown status "+y.status)}}}}},error:function(y){u(y.responseText)}})},signInputs:function(A,x,D,B){console.log("Offer.signInputs()");var E=this;try{var y={};var t=[];for(var w=0;w<A.signature_requests.length;++w){var v=A.signature_requests[w];var C=new Bitcoin.Script(Crypto.util.hexToBytes(v.connected_script));if(C==null){throw"signInputs() Connected script is null"}C.tx_input_index=v.tx_input_index;C.offer_outpoint_index=v.offer_outpoint_index;var s=C.simpleOutPubKeyHash();var u=new Bitcoin.Address(s).toString();if(y[u]){C.priv_to_use=y[u]}else{if(n[u]){C.priv_to_use=Bitcoin.Base58.decode(n[u])}else{if(MyWallet.addressExists(u)&&!MyWallet.isWatchOnly(u)){C.priv_to_use=MyWallet.decodePK(MyWallet.getPrivateKey(u))}}}if(C.priv_to_use==null){throw"Private key not found"}else{y[u]=C.priv_to_use}t.push(C)}E.signNormal(x,t,function(F){D(F)},function(F){B(F)})}catch(z){B(z)}}}};this.generateAddressAndKeyFromCustomSeed=function(t,w){var v=Crypto.SHA256(t+w,{asBytes:true});var u=new Bitcoin.ECKey(v);if(t.indexOf(i)==0){var s=u.getBitcoinAddressCompressed()}else{if(v[0]%2==0){var s=u.getBitcoinAddress()}else{var s=u.getBitcoinAddressCompressed()}}return{address:s,key:u}};this.generateAddressFromCustomSeed=function(t,u){var s=this.generateAddressAndKeyFromCustomSeed(t,u);n[s.address.toString()]=Bitcoin.Base58.encode(s.key.priv);return s.address};this.newPlan=function(){return{offers:[],n_stages:0,c_stage:0,address_seed:null,address_seen_n:0,generated_addresses:[],fee_percent_each_repetition:[],fee_each_repetition:[],to_addresses:{},generateAddressFromSeed:function(){if(this.address_seed==null){MyWallet._seed();var t=new Array(18);new SecureRandom().nextBytes(t);this.address_seed=Crypto.util.bytesToHex(t);MyWallet.addAdditionalSeeds(i+this.address_seed)}if(this.address_seen_n>=100){throw"Generating An Address Seed Greater than 100 Index. Please file an issue on Shared Coin github"}var s=o.generateAddressFromCustomSeed(i+this.address_seed,this.address_seen_n);this.address_seen_n++;return s},sanityCheck:function(F,z){try{var I=this;if(I.offers.length==0){throw"No Offers"}var s=BigInteger.valueOf(o.getMinimumFee());for(var u in I.offers){var C=I.offers[u];var H=BigInteger.ZERO;var G=BigInteger.ZERO;if(C.offered_outpoints.length>o.getMaximumOfferNumberOfInputs()){throw"Number of inputs greater than maximum"}for(var E in C.offered_outpoints){var D=C.offered_outpoints[E];if(D.value<o.getMinimumInputValue()){throw"Input value less than minimum"}if(D.value>o.getMaximumInputValue()){throw"Input value greater than maximum"}H=H.add(BigInteger.valueOf(D.value))}if(C.request_outputs.length>o.getMaximumOfferNumberOfOutputs()){throw"Number of outputs greater than maximum"}for(var E in C.request_outputs){var x=C.request_outputs[E];if(!x.script){throw"Output script null"}if(x.value<=0){throw"Output value <= 0"}if(x.exclude_from_fee){if(x.value<o.getMinimumOutputValueExcludingFee()){throw"Output value less than minimum value excluding fee"}}else{if(x.value<o.getMinimumOutputValue()){throw"Output value less than minimum"}}if(x.value>o.getMaximumOutputValue()){throw"Output value greater than maximum"}var A=new Script(Crypto.util.hexToBytes(x.script));var t=[];A.extractAddresses(t);if(t.length>1){throw"Multiple output addresses"}var B=t[0].toString();var v=BigInteger.valueOf(x.value);if(I.to_addresses[B]){if(I.to_addresses[B].compareTo(v)!=0){throw"Wrong Value Sent To "+B}else{delete I.to_addresses[B]}}else{if(MyWallet.addressExists(B)){}else{if(n[B]){}else{throw"Unknown Address "+B}}}G=G.add(v)}if(H.compareTo(G)<0){throw"valueInput < valueOutput"}var y=H.subtract(G);if(y.compareTo(s)<0){throw"Fee is too small"}if(y.compareTo(BigInteger.valueOf(satoshi))>0){throw"Fee seems unusually large"}}if(m(I.to_addresses)!=0){throw"Some recipient outputs missing"}F()}catch(w){console.log(w);z("Sanity Check Failed "+w+" : Please report to developers")}},toString:function(){var s=this;var u="----- PLAN -----\n";u+="fee_percent_each_repetition "+s.fee_percent_each_repetition+"\n";u+="fee_each_repetition "+s.fee_each_repetition+"\n";u+="address_seen_n "+s.address_seen_n+"\n";u+="address_seed "+s.address_seed+"\n";u+="generated_addresses "+s.generated_addresses+"\n";u+="Offers [\n";for(var t in s.offers){u+=j(s.offers[t].toString())+"\n"}u+="]\n";u+="----- END PLAN -----";return u},generateChangeAddress:function(){var t=MyWallet.generateNewKey();if(!t||!t.addr){throw"Error Generating Change Address"}var s=t.addr;this.generated_addresses.push(s);return new Bitcoin.Address(s)},executeOffer:function(w,x,u,t){function s(z,y){console.log("executeOffer.complete");w.determineOutputsToOfferNextStage(z,y,function(A){x(A)},u)}var v=0;t(++v,k);w.submit(function(){console.log("Successfully Submitted Offer");t(++v,k);w.pollForProposalID(function(y){console.log("Proposal ID "+y);t(++v,k);w.getProposal(y,function(z){console.log("Got Proposal");t(++v,k);w.checkProposal(z,function(A){console.log("Proposal Looks Good");t(++v,k);w.signInputs(z,A,function(B){console.log("Inputs Signed");t(++v,k);w.submitInputScripts(z,B,function(C){console.log("Submitted Input Scripts");t(++v,k);z.pollForCompleted(s,u)},u,s)},u)},u)},u,s)},u)},u,s)},execute:function(w,u,t){var s=this;var v=function(z){s.c_stage=z;var B=s.offers[z];console.log("Executing Stage "+z);var A=function(H){try{z++;if(z<s.n_stages){var F=s.offers[z];for(var D in H){var J=H[D];for(var E in F.offered_outpoints){var I=F.offered_outpoints[E];if(J.script==I.script&&J.value==I.value){$.extend(I,J);break}}}v(z)}else{if(z==s.n_stages){w()}}}catch(G){u(G)}};for(var C in B.offered_outpoints){var y=B.offered_outpoints[C];if(!y.hash){throw"Failed to connect input "+z}}var x=function(D){t(D+(k*s.c_stage),k*s.offers.length)};s.executeOffer(B,A,function(D){console.log("executeOffer failed "+D);setTimeout(function(){s.executeOffer(B,A,u,x)},5000)},x)};MyWallet.backupWallet("update",function(){console.log("Saved Wallet");var A=MyWallet.getAdditionalSeeds();var z=false;for(var y in A){var x=A[y];if(x.indexOf(s.address_seed)>=0){z=true;break}}if(!z){u("Address Seed Not Found")}else{v(0)}},u)},constructRepetitions:function(Y,ab,S,F){try{var x=this;var D=BigInteger.ZERO;for(var U in Y.offered_outpoints){D=D.add(BigInteger.valueOf(Y.offered_outpoints[U].value))}var R=D.subtract(ab);var t=ab;Y.fee_percent=x.fee_percent_each_repetition[x.n_stages-1];var X=[10,5,1,0.5,0.3,0.1,0.05];var H=15;var J;for(var M=0;M<x.n_stages-1;++M){var E=o.newOffer();if(M==0){E.offered_outpoints=Y.offered_outpoints.slice(0);Y.offered_outpoints=[]}else{for(var V in J.request_outputs){var G=J.request_outputs[V];if(!G.exclude_from_fee){E.offered_outpoints.push(G)}}}E.fee_percent=x.fee_percent_each_repetition[M];R=R.subtract(x.fee_each_repetition[M]);var L=8;var K=Math.random();if(R.intValue()>=0.05*satoshi){var y=2;if(R.intValue()>=0.1*satoshi&&K>=0.5){y=3}}else{var y=1}var O=BigInteger.ZERO;if(t.compareTo(BigInteger.ZERO)<0){throw"totalChangeValueLeftToConsume < 0"}else{if(t.compareTo(BigInteger.ZERO)>0){var T=Math.min(Math.max(x.n_stages-2,1),3);var B=(100/T)*((Math.random()*0.5)+0.75);O=ab.divide(BigInteger.valueOf(100)).multiply(BigInteger.valueOf(Math.ceil(B)))}}if(O.compareTo(BigInteger.valueOf(o.getMinimumOutputValue()))<=0||t.subtract(O).compareTo(BigInteger.valueOf(o.getMinimumOutputValue()))<=0){O=t;t=BigInteger.ZERO}else{t=t.subtract(O)}if(t.compareTo(BigInteger.ZERO)<0){throw"totalChangeValueLeftToConsume < 0"}var Z=R.add(t);var w=false;for(var V=0;V<1000;++V){for(var N in X){var z=(X[N]/100)*((Math.random()*(H*2))-H);var P=BigInteger.valueOf(Math.round((X[N]+z)*satoshi));var u=Z.divideAndRemainder(P);var aa=u[0].intValue();if(aa>o.getMaximumOfferNumberOfOutputs()){continue}if(aa>=y&&aa<=L){if(u[1].compareTo(BigInteger.ZERO)==0||u[1].compareTo(BigInteger.valueOf(o.getMinimumOutputValue()))>=0){var I=[];if(u[1].compareTo(BigInteger.ZERO)>0){if(aa<=1){if(u[1].compareTo(o.getMinimumInputValue())<0||u[1].compareTo(o.getMaximumOutputValue())>0){continue}var s=x.generateAddressFromSeed();E.request_outputs.push({value:u[1].toString(),script:Crypto.util.bytesToHex(Script.createOutputScript(s).buffer)})}else{I=c(u[1].intValue(),aa)}}var A=true;for(var C=0;C<aa;++C){var Q=P;if(I[C]&&I[C]>0){Q=Q.add(BigInteger.valueOf(I[C]))}if(Q.compareTo(o.getMinimumInputValue())<0||Q.compareTo(o.getMaximumOutputValue())>0){A=false;break}}if(!A){continue}for(var C=0;C<aa;++C){var s=x.generateAddressFromSeed();var Q=P;if(I[C]&&I[C]>0){Q=Q.add(BigInteger.valueOf(I[C]))}E.request_outputs.push({value:Q.toString(),script:Crypto.util.bytesToHex(Script.createOutputScript(s).buffer)})}w=true;break}}}if(w){break}}if(!w){var s=x.generateAddressFromSeed();E.request_outputs.push({value:Z.toString(),script:Crypto.util.bytesToHex(Script.createOutputScript(s).buffer)})}if(O.compareTo(BigInteger.ZERO)>0){var v=x.generateChangeAddress();if(O.compareTo(BigInteger.valueOf(o.getMinimumOutputValueExcludingFee()))<0){throw"Change Value Too Small 0 ("+O.toString()+" < "+o.getMinimumOutputValueExcludingFee()+")"}E.request_outputs.push({value:O.toString(),script:Crypto.util.bytesToHex(Script.createOutputScript(v).buffer),exclude_from_fee:true})}x.offers.push(E);J=E}for(var V in J.request_outputs){var G=J.request_outputs[V];if(!G.exclude_from_fee){Y.offered_outpoints.push(G)}}if(t.compareTo(BigInteger.ZERO)>0){var v=x.generateChangeAddress();if(t.compareTo(BigInteger.valueOf(o.getMinimumOutputValueExcludingFee()))<0){throw"Change Value Too Small 1 ("+t.toString()+" < "+o.getMinimumOutputValueExcludingFee()+")"}Y.request_outputs.push({value:t.toString(),script:Crypto.util.bytesToHex(Script.createOutputScript(v).buffer),exclude_from_fee:true})}x.offers.push(Y);S(x)}catch(W){F(W)}}}};this.getMaximumOfferNumberOfInputs=function(){return a.maximum_offer_number_of_inputs};this.getMaximumOfferNumberOfOutputs=function(){return a.maximum_offer_number_of_outputs};this.getMinimumOutputValue=function(){return a.minimum_output_value};this.getMinimumOutputValueExcludingFee=function(){return a.minimum_output_value_exclude_fee};this.getToken=function(){return a.token};this.getMinimumInputValue=function(){return a.minimum_input_value};this.getMaximumInputValue=function(){return a.maximum_input_value};this.getMinimumSupportedVersion=function(){return a.min_supported_version};this.getIsEnabled=function(){return a.enabled};this.getMaximumOutputValue=function(){return a.maximum_output_value};this.getFee=function(){return a.fee_percent};this.getMinimumFee=function(){return a.minimum_fee?a.minimum_fee:0};this.constructPlan=function(v,B,N){try{var I=this;var O=v.find('select[name="repetitions"]');var u=v.find('input[name="shared-coin-donate"]').is(":checked");var D=parseInt(O.val());if(D<=0){throw"invalid number of repetitions"}console.log("constructPlan() Number Of Repetitions "+D+" Donate "+u);var w=o.newPlan();function y(W){for(var V in w.generated_addresses){MyWallet.deleteAddress(w.generated_addresses[V])}N(W)}var R=initNewTx();R.from_addresses=MyWallet.getActiveAddresses();var C=v.find(".recipient");if(C.length>o.getMaximumOfferNumberOfOutputs()){throw"The Maximum Number Of Recipients is "+o.getMaximumOfferNumberOfOutputs()}var G={};C.each(function(){try{var ac=$(this);var aa=ac.find('input[name="send-value"]');var X=ac.find('input[name="send-to-address"]');var Y=0;try{Y=precisionToSatoshiBN(aa.val());if(Y==null||Y.compareTo(BigInteger.ZERO)<=0){throw"You must enter a value greater than zero"}}catch(Z){throw"Invalid send amount"}if(Y.compareTo(BigInteger.valueOf(o.getMinimumOutputValue()))<0){throw"Output Value Too Small"}var V=$.trim(X.val()).replace(/[\u200B-\u200D\uFEFF]/g,"");if(V==null||V.length==0){throw"You must enter a bitcoin address for each recipient"}var W=resolveAddress(V);if(W==null||W.length==0){throw"You must enter a bitcoin address for each recipient"}if(G[W]){throw"Shared Coin does not support multiple outputs to the same recipient"}G[W]=true;var ab=new Bitcoin.Address(W);if(ab.version!=0){throw"Shared Coin only supports sending payments to regular bitcoin addresses"}R.to_addresses.push({address:ab,value:Y});w.to_addresses[W]=Y}catch(Z){y(Z)}});if(R.to_addresses.length==0||R.to_addresses.length<C.length){return}var s=[];var z=[];var Q=[];var L=[];if(u){var T=(Math.random()*(r-q))+q;var K=(T/2)*((Math.random()*1.8)+0.2);K=K.toFixed(4);L.push(K);L.push(T-K)}for(var P in R.to_addresses){var U=R.to_addresses[P];s.push(U.value);for(var F=D-1;F>=0;--F){var A=o.getFee();if(L.length>0){A+=L.pop()}Q[F]=A;var J=o.calculateFeeForValue(A,U.value);U.value=U.value.add(J);var H=z[F];if(H){z[F]=H.add(J)}else{z[F]=J}}}var E="1BitcoinEaterAddressDontSendf59kuE";R.min_input_confirmations=1;R.do_not_use_unspent_cache=true;R.allow_adjust=false;R.change_address=new Bitcoin.Address(E);R.base_fee=BigInteger.ZERO;R.min_input_size=BigInteger.valueOf(o.getMinimumInputValue());R.fee=BigInteger.ZERO;R.ask_for_fee=function(W,V){V()};function x(V){var Z={};var Y={};for(var X in V){var W=V[X];var aa=new Bitcoin.Address(W.script.simpleOutPubKeyHash()).toString();Z[aa]=true;Y[W.outpoint.hash]=true}return Math.min(m(Z),m(Y))}var M=BigInteger.valueOf(satoshi);R.isSelectedValueSufficient=function(X,Y,V){var W=this;if(W.selected_outputs.length>=o.getMaximumOfferNumberOfInputs()){return true}if(Y.compareTo(X.add(M))>=0&&x(V)>1){return true}return false};var t=o.newOffer();R.addListener({on_error:function(V){y()}});R.signInputs=function(){try{var ag=this;if(ag.tx.ins.length>o.getMaximumOfferNumberOfInputs()){y("Maximum number of inputs exceeded. Please consolidate some or lower the send amount");return}for(var Y=0;Y<ag.tx.ins.length;++Y){var ae=ag.tx.ins[Y];var W=ae.outpoint.hash;var ad=Crypto.util.bytesToHex(Crypto.util.base64ToBytes(W).reverse());t.offered_outpoints.push({hash:ad,index:ae.outpoint.index,value:ae.outpoint.value.toString()})}var Z=BigInteger.ZERO;for(var Y=0;Y<ag.tx.outs.length;++Y){var X=ag.tx.outs[Y];var ac=X.value.slice(0);ac.reverse();var af=new BigInteger(ac);var V=new Bitcoin.Script(X.script).simpleOutPubKeyHash();var ab=new Bitcoin.Address(V).toString();if(ab.toString()==E){Z=Z.add(af)}else{t.request_outputs.push({value:s[Y].toString(),script:Crypto.util.bytesToHex(X.script.buffer)})}}if(Z.compareTo(BigInteger.ZERO)==0){throw"Transaction does not have any change. Shared Coin cannot send the exact amount available in the wallet."}w.n_stages=D;w.c_stage=0;w.fee_each_repetition=z;w.fee_percent_each_repetition=Q;w.constructRepetitions(t,Z,B,function(ah){y(ah)})}catch(aa){y(aa)}};R.start()}catch(S){y(S)}};this.calculateFeeForValue=function(w,t){var u=BigInteger.valueOf(o.getMinimumFee());if(t.compareTo(BigInteger.ZERO)>0&&w>0){var v=Math.ceil(100/w);var s=t.divide(BigInteger.valueOf(v));return u.add(s)}else{return u}};this.recoverSeeds=function(v,w,y){MyWallet.disableLogout(true);var z=$("#sharedcoin-recover-progress-modal");var s=z.find(".bar");z.modal("show");s.width("0%");var u=function(C){z.modal("hide");y(C)};var B=function(C){z.modal("hide");w(C)};var t=0;var A=0;function x(){if(!z.is(":visible")){return}if(t>=v.length){if(A>0){MyWallet.get_history();MyWallet.makeNotice("success","misc-success",formatBTC(A)+" recovered from intermediate addresses")}B();return}s.width(((t/v.length)*100)+"%");var E=v[t];++t;var G={};for(var F=0;F<100;++F){var D=o.generateAddressAndKeyFromCustomSeed(E,F);var C=D.address.toString();if(!MyWallet.addressExists(C)){G[C]=D.key}}BlockchainAPI.get_balances(Object.keys(G),function(K){try{var L=0;for(var I in K){var M=K[I].final_balance;if(M>0){console.log("Balance "+I+" = "+M);var H=G[I];var J=H.getBitcoinAddress().toString();try{if(MyWallet.addPrivateKey(H,{compressed:I!=J,app_name:IMPORTED_APP_NAME,app_version:IMPORTED_APP_VERSION})){console.log("Imported "+I)}}catch(N){console.log("Error importing "+I)}}L+=M}if(L>0){A+=L;MyWallet.backupWalletDelayed("update",function(){setTimeout(x,500)})}else{setTimeout(x,500)}}catch(N){u(N)}},u)}setTimeout(x,100)};this.init=function(w,u){if(!MyWallet.getSharedcoinEndpoint()||MyWallet.getSharedcoinEndpoint().length==0){(function(A,C,B){if(!C.is(":visible")){return}if(B>10){return}++B;setTimeout(function(){A.init(C)},2000)})(this,w,u);return}$("#sharedcoin-recover").unbind().click(function(){var A=$(this);MyWallet.getSecondPassword(function(){A.prop("disabled",true);var E=A.text();A.text("Working. Please Wait...");var F=MyWallet.getAdditionalSeeds();var B=[];for(var D in F){var C=F[D];if(C.indexOf(i)==0||C.indexOf(e)==0){B.push(C)}}B.reverse();o.recoverSeeds(B,function(){A.prop("disabled",false);A.text(E)},function(G){A.prop("disabled",false);A.text(E);MyWallet.makeNotice("error","misc-error",G)})})});var z=w.find(".send");var x=w.find(".send-options");var t=w.find('select[name="repetitions"]');z.unbind().prop("disabled",true);w.find('input[name="send-value"]').bind("keyup change",function(){s()});x.hide();function y(){var A=x.find("span");A.eq(0).text(formatBTC(o.getMaximumOutputValue()));A.eq(1).text(formatBTC(o.getMinimumOutputValue()));A.eq(2).text(o.getFee());A.eq(3).text(formatBTC(o.getMinimumFee()));x.show()}function v(){var A=BigInteger.ZERO;w.find('input[name="send-value"]').each(function(){A=A.add(precisionToSatoshiBN($(this).val()))});return A}function s(){z.unbind();var B=parseInt(t.val());if(B>0&&o.getIsEnabled()&&b>=o.getMinimumSupportedVersion()){var A=v();if(A.compareTo(BigInteger.valueOf(o.getMinimumOutputValue()))<0){z.prop("disabled",true)}else{if(A.compareTo(BigInteger.valueOf(o.getMaximumOutputValue()))>0){z.prop("disabled",true)}else{z.prop("disabled",false);z.unbind().click(function(){p.setProgressInfo();MyWallet.disableLogout(true);var C=function(F,E){console.log("Fatal Error");p.setProgressError();w.find("input,select,button").prop("disabled",false);s();MyWallet.disableLogout(false);MyWallet.makeNotice("error","misc-error",F,(E&&E.c_stage)>0?60000:10000);setTimeout(function(){if(E&&E.c_stage>=0){console.log("Recover Seeds");p.hide();o.recoverSeeds([i+E.address_seed],function(){p.show()},function(){p.show()})}},1000);p.enableCancel()};var D=function(){p.setProgressSuccess();w.find("input,select,button").prop("disabled",false);MyWallet.makeNotice("success","misc-success","Shared Coin Transaction Successfully Completed");MyWallet.disableLogout(false);p.hide();s()};if(A.compareTo(BigInteger.valueOf(o.getMinimumOutputValue()))<0){MyWallet.makeNotice("error","misc-error","The Minimum Send Value is "+formatPrecision(o.getMinimumOutputValue()));return}else{if(A.compareTo(BigInteger.valueOf(o.getMaximumOutputValue()))>0){MyWallet.makeNotice("error","misc-error","The Maximum Send Value is "+formatPrecision(o.getMaximumOutputValue()));return}}MyWallet.getSecondPassword(function(){loadScript("wallet/signer",function(){p.show();p.disableCancel();var H=v();var F=w.find(".recipient");if(F.length==1){var I=F.find('input[name="send-to-address"]').val()}else{var I="Multiple Recipients"}p.setAddressAndAmount(I,H);w.find("input,select,button").prop("disabled",true);MyWallet.setLoadingText("Constructing Plan. Please Wait.");var E=new Date().getTime()-l;var G=Math.max(0,f-E);if(G>0){$(".loading-indicator").fadeIn(200)}setTimeout(function(){$(".loading-indicator").hide();o.constructPlan(w,function(J){console.log("Created Plan");J.sanityCheck(function(){console.log("Sanity Check OK");J.execute(D,function(K){C(K,J)},function(K,L){p.setProgress(K,L+1)})},C)},C)},G)},C)},C)})}}}else{z.prop("disabled",true)}}MyWallet.setLoadingText("Fetching Shared Coin Info");$.retryAjax({dataType:"json",type:"POST",url:g,timeout:h,retryLimit:d,data:{method:"get_info",format:"json"},success:function(C){try{a=C;if(!o.getIsEnabled()){throw"Shared Coin is currently disabled"}if(b<o.getMinimumSupportedVersion()){throw"Version out of date. Please update your client or reload the page."}y();t.empty();for(var A=C.recommended_min_iterations;A<=C.recommended_max_iterations;A+=1){t.append('<option value="'+(A)+'">'+(A)+" Repetitions</option>")}t.val(C.recommended_iterations)}catch(B){MyWallet.makeNotice("error","misc-error",B)}s()},error:function(A){z.prop("disabled",true);MyWallet.makeNotice("error","misc-error",A.responseText)}});s()}};