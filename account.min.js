function updateKV(a,e,c,d,b){if(!isInitialized||offline){return}if(c==null||c.length==0){makeNotice("error","misc-error",a+": Invalid value");return}if(sharedKey==null||sharedKey.length==0||sharedKey.length!=36){makeNotice("error","misc-error","Shared key is invalid");return}c=$.trim(c);if(c.length==0){makeNotice("error",e+"-error",data.responseText);if(b){b()}return}setLoadingText(a);$.post("/wallet",{guid:guid,sharedKey:sharedKey,length:(c+"").length,payload:c+"",method:e,format:"plain"},function(f){makeNotice("success",e+"-success",f);if(d){d()}}).error(function(f){makeNotice("error",e+"-error",f.responseText);if(b){b()}})}function setDoubleEncryptionButton(){if(double_encryption){$(".double-encryption-off").hide();$(".double-encryption-on").show()}else{$(".double-encryption-on").hide();$(".double-encryption-off").show()}$("#double-password").val("");$("#double-password2").val("")}function setDoubleEncryption(d){var c=function(g){console.log("Panic "+g);window.location.reload()};try{if(double_encryption==d){return}if(d){var a=$("#double-password").val();var b=$("#double-password2").val();if(a==null||a.length==0||a.length<4||a.length>255){makeNotice("error","misc-error","Password must be 4 characters or more in length");return}if(a!=b){makeNotice("error","misc-error","Passwords do not match.");return}if(a==password){makeNotice("error","misc-error","Second password should not be the same as your main password.");return}getSecondPassword(function(){try{double_encryption=true;dpassword=a;for(var j in addresses){var l=addresses[j];if(l.priv!=null){l.priv=encodePK(B58.decode(l.priv))}}var g=Crypto.SHA256(sharedKey+dpassword,{asBytes:true});for(var h=1;h<pbkdf2_iterations;++h){g=Crypto.SHA256(g,{asBytes:true})}dpasswordhash=Crypto.util.bytesToHex(g);dpassword=null;getSecondPassword(function(){try{checkAllKeys();backupWallet("update",function(){setDoubleEncryptionButton()},function(){c(i)})}catch(i){c(i)}},function(){c()})}catch(k){c(k)}},function(){c()})}else{getSecondPassword(function(){try{for(var g in addresses){var i=addresses[g];if(i.priv!=null){i.priv=decryptPK(i.priv)}}double_encryption=false;dpassword=null;checkAllKeys();backupWallet("update",function(){setDoubleEncryptionButton()},function(){c(h)})}catch(h){c(h)}},function(){c()})}}catch(f){c(f)}}function getAccountInfo(){if(!isInitialized||offline){return}setLoadingText("Getting Wallet Info");$.post("/wallet",{guid:guid,sharedKey:sharedKey,method:"get-info",format:"plain"},function(g){if(g.email!=null){$("#wallet-email").val(g.email);$(".my-email").text(g.email)}$("#wallet-phrase").val(g.phrase);$("#two-factor-select").val(g.auth_type);$(".two-factor").hide();$(".two-factor.t"+g.auth_type).show(200);var h=$("#notifications-type");h.find(":checkbox").prop("checked",false);h.find('[class^="type"]').hide();for(var j in g.notifications_type){var k=g.notifications_type[j];h.find(':checkbox[value="'+k+'"]').prop("checked",true);h.find(".type-"+k).show()}$(".logl").hide();$(".logl.l"+g.logging_level).show();$("#logging-level").val(g.logging_level);$("#notifications-confirmations").val(g.notifications_confirmations);$("#notifications-on").val(g.notifications_on);if(g.alias!=null&&g.alias.length>0){$("#wallet-alias").val(g.alias);$(".alias").text("https://blockchain.info/wallet/"+g.alias);$(".alias").show(200)}var b=$("#local_currency").empty();for(var l in g.currencies){var o=g.currencies[l];b.append('<option value="'+l+'">'+o+"</option>")}b.val(g.currency);var e=$("#language_select").empty();for(var f in g.languages){var n=g.languages[f];e.append('<option value="'+f+'">'+n+"</option>")}e.val(g.language);loadScript(resource+"wallet/qr.code.creator.js",function(){try{var p=makeQRCode(300,300,1,guid+"|"+sharedKey+"|"+password);$("#device-qr-code").empty().append(p);if(g.google_secret_url!=null&&g.google_secret_url.length>0){var i=makeQRCode(300,300,1,g.google_secret_url);$("#wallet-google-qr").empty().append(i)}}catch(q){makeNotice("error","misc-error",q)}});if(g.auto_email_backup==1){$("#auto-email-backup").prop("checked",true)}else{$("#auto-email-backup").prop("checked",false)}if(g.never_save_auth_type==1){$("#never-save-auth-type").prop("checked",true)}else{$("#never-save-auth-type").prop("checked",false)}$("#wallet-http-url").val(g.http_url);$("#wallet-http-url").val(g.http_url);$("#wallet-skype").val(g.skype_username);$("#wallet-boxcar").val(g.boxcar_email);$("#wallet-yubikey").val(g.yubikey);if(g.password_hint1){$("#password-hint1").val(g.password_hint1)}if(g.password_hint2){$("#password-hint2").val(g.password_hint2)}$("#ip-lock").val(g.ip_lock);$("#my-ip").text(g.my_ip);if(g.ip_lock_on==1){$("#ip-lock-on").prop("checked",true)}else{$("#ip-lock-on").prop("checked",false)}$('input[name="fee-policy"]').each(function(){if(parseInt($(this).val())==fee_policy){$(this).attr("checked",true)}});if(g.email_verified==0){$("#verify-email").show();$("#email-verified").hide()}else{$("#verify-email").hide();$("#email-verified").show()}$("#my-ip").text(g.my_ip);var a="1";if(g.sms_number){var d=g.sms_number.split(" ");if(g.sms_number[0]=="+"&&d.length>1){a=d[0].substring(1);$(".wallet-sms").val(d[1])}else{$(".wallet-sms").val(g.sms_number)}}if(g.sms_verified==0){$(".sms-unverified").show();$(".sms-verified").hide()}else{$(".sms-verified").show().trigger("show");$(".sms-unverified").hide()}$.get(resource+"wallet/country_codes.html").success(function(i){$('select[class="wallet-sms-country-codes"]').html(i).val(a)}).error(function(){makeNotice("error","misc-error","Error Downloading SMS Country Codes")});var m=function(s,p,q){try{if(window.webkitNotifications&&navigator.userAgent.indexOf("Chrome")>-1){var i=webkitNotifications.checkPermission();if(i==1&&q){webkitNotifications.requestPermission(m)}else{if(i==0){s()}else{p()}}}else{if(window.Notification){if(Notification.permissionLevel()==="default"&&q){Notification.requestPermission(m)}else{if(window.Notification.permissionLevel()=="granted"){s()}else{p()}}}else{p()}}}catch(r){console.log(r);p()}};var c=$("#html5-notifications-checkbox");c.change(function(){if($(this).is(":checked")){m(function(){makeNotice("success","misc-success","HTML5 Notifications Enabled");html5_notifications=true;backupWallet()},function(){makeNotice("error","misc-error","Error Enabling HTML5 Notifications");html5_notifications=false;backupWallet()},true)}else{html5_notifications=false;backupWallet()}});if(html5_notifications){c.attr("checked",true)}else{c.attr("checked",false)}}).error(function(a){makeNotice("error","misc-error",a.responseText)})}function bindAccountButtons(){var a=$("#notifications-type");a.find(":checkbox").unbind().change(function(){var d=[];a.find(":checkbox:checked").each(function(){d.push($(this).val())});if(!d.length){d.push(0)}updateKV("Updating Notifications Type","update-notifications-type",d.join("|"));a.find(".type-"+$(this).val()).toggle();BlockchainAPI.get_history()});$("input[name=fee-policy]").change(function(){fee_policy=$("input[name=fee-policy]:checked").val();backupWalletDelayed()});$("#password-hint1").unbind().change(function(){updateKV("Updating Main Password Hint","update-password-hint1",$(this).val())});$("#password-hint2").unbind().change(function(){updateKV("Updating Second Password Hint","update-password-hint2",$(this).val())});$("#ip-lock-on").unbind().change(function(){updateKV("Updating IP Lock","update-ip-lock-on",$(this).is(":checked"))});$("#ip-lock").unbind().change(function(){updateKV("Updating Locked Ip Addresses","update-ip-lock",$(this).val())});$("#notifications-on").unbind().change(function(){updateKV("Updating Notifications Settings","update-notifications-on",$(this).val())});$("#auto-email-backup").unbind().change(function(){updateKV("Updating Auto Backup Settings","update-auto-email-backup",$(this).is(":checked"))});$("#never-save-auth-type").unbind().change(function(){updateKV("Updating Auth Saving Settings","update-never-save-auth-type",$(this).is(":checked"))});$("#two-factor-select").unbind().change(function(){var d=parseInt($(this).val());updateKV("Updating Two Factor Authentication","update-auth-type",d,function(){if(d==4){getAccountInfo()}updateCacheManifest()});$(".two-factor").hide(200);$(".two-factor.t"+d).show(200)});$("#wallet-email-send").click(function(){$("#wallet-email").trigger("change")});var b="";$("#wallet-email").unbind().change(function(f){var d=$.trim($(this).val());if(d.length==0){return}if(b==d){return}if(!validateEmail(d)){makeNotice("error","misc-error","Email address is not valid");return}updateKV("Updating Email","update-email",d,function(){b=d},function(){b=""});b=d;$("#verify-email").show(200);$("#email-verified").hide()});$("#wallet-double-encryption-enable").click(function(d){setDoubleEncryption(true)});$("#wallet-double-encryption-disable").click(function(d){setDoubleEncryption(false)});$("#wallet-email-code").unbind().change(function(f){if(!isInitialized||offline){return}var d=$(this).val();if(d==null||d.length==0||d.length>255){makeNotice("error","misc-error","You must enter a code to verify");return}d=$.trim(d);setLoadingText("Verifying Email");$.post("/wallet",{guid:guid,format:"plain",payload:d,sharedKey:sharedKey,length:d.length,method:"verify-email"},function(e){makeNotice("success","misc-success",e);$("#verify-email").hide();$("#email-verified").show(200)}).error(function(e){makeNotice("error","misc-error",e.responseText);$("#verify-email").show(200);$("#email-verified").hide()})});$(".wallet-sms-code").unbind().change(function(f){var d=$(this).val();if(d==null||d.length==0||d.length>255){makeNotice("error","misc-error","You must enter an SMS code to verify");return}d=$.trim(d);setLoadingText("Verifying SMS Code");$.post("/wallet",{guid:guid,format:"plain",payload:d,sharedKey:sharedKey,length:d.length,method:"verify-sms"},function(e){makeNotice("success","misc-success",e);$(".sms-unverified").hide();$(".sms-verified").show(200).trigger("show")}).error(function(e){makeNotice("error","misc-error",e.responseText);$(".sms-verified").hide();$(".sms-unverified").show(200)})});$(".send-code").click(function(){$(this).parent().find(".wallet-sms").trigger("change")});$('select[class="wallet-sms-country-codes"]').change(function(){$(".wallet-sms").trigger("change")});var c;$(".wallet-sms").unbind().change(function(d){var f=$.trim($(this).val());if(f==null||f.length==0){return}if(f.charAt(0)!="+"){f="+"+$(".wallet-sms-country-codes").val()+f}if(c==f){return}c=f;updateKV("Updating Cell Number","update-sms",f,function(){$(".sms-unverified").show(200);$(".sms-verified").hide()})});$("#run-key-check").click(function(){getSecondPassword(function(){try{checkAllKeys(true);backupWallet()}catch(d){makeNotice("error","misc-error",d)}})});$("#local_currency").unbind().change(function(){if(symbol!=symbol_local){toggleSymbol()}updateKV("Updating Local Currency","update-country",$(this).val(),function(){BlockchainAPI.get_history()})});$("#language_select").unbind().change(function(){updateKV("Updating Language","update-language",$(this).val(),function(){updateCacheManifest(function(){window.location.reload()})})});$("#notifications-confirmations").unbind().change(function(d){updateKV("Updating Notification Confirmations","update-notifications-confirmations",$(this).val())});$("#account-logging").on("show",function(){var e=$(this).find("table").hide();var d=e.find("tbody");$.get(root+"wallet/list-logs?guid="+guid+"&sharedKey="+sharedKey+"&format=plain").success(function(k){try{e.show();d.empty();if(k==null){throw"Failed to get backups"}var h=k.results;if(h.length==0){throw"No logs found"}for(var g in h){var f=h[g];d.append('<tr><td style="width:130px">'+dateToString(new Date(f.time))+'</td><td style="width:170px">'+f.action+'</td><td style="text-overflow: ellipsis;max-width:100px;overflow: hidden;">'+f.ip_address+"</td><td>"+f.user_agent+"</td></tr>")}}catch(j){makeNotice("error","misc-error",j)}}).error(function(f){makeNotice("error","misc-error",f.responseText)})});$("#logging-level").unbind().change(function(d){$(".logl").hide();$(".logl.l"+$(this).val()).show();updateKV("Updating Logging Level","update-logging-level",$(this).val())});$("#wallet-yubikey").unbind().change(function(d){updateKV("Updating Yubikey","update-yubikey",$(this).val())});$("#wallet-skype").unbind().change(function(d){updateKV("Updating Skype Username","update-skype",$(this).val())});$("#wallet-boxcar").unbind().change(function(d){updateKV("Updating Boxcar Email","update-boxcar",$(this).val())});$("#wallet-http-url").unbind().change(function(d){updateKV("Updating HTTP url","update-http-url",$(this).val())});$("#wallet-phrase").unbind().change(function(f){var d=$(this).val();if(d==null||d.length==0||d.length>255){makeNotice("error","misc-error","You must enter a secret phrase");return}updateKV("Updating Secret Phrase","update-phrase",d)});$("#wallet-alias").unbind().change(function(d){$(this).val($(this).val().replace(/[\.,\/ #!$%\^&\*;:{}=`~()]/g,""));if($(this).val().length>0){$(".alias").fadeIn(200);$(".alias").text("https://blockchain.info/wallet/"+$(this).val())}updateKV("Updating Alias","update-alias",$(this).val())})};